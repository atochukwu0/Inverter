\chapter{Desarrollo}

\section{Modelo matemático del PMSM}

En esta sección, se abordará de manera gradual la introducción al control vectorial de máquinas eléctricas. Esta sección se asemeja más a un conjunto de pasos para comprender completamente el control utilizado en los inversores. Es importante tener en cuenta que existen muchas simplificaciones matemáticas, suposiciones no justificadas y pasos omitidos ya que la extensión de la sección sería extremadamente larga en caso de razonar desde cero todos los resultados.

\subsection{Marco de referencia estático}

Los motores síncronos de imanes permanentes (PMSM) están hechos de hierro, cobre y imanes. Se limita el análisis a máquinas de tres fases, aunque el análisis para sistemas con más de tres fases es similar. El cobre se distribuye en devanados, que tienen una resistencia y una inductancia iguales entre ellas si la máquina está equilibrada. Además, cuando el rotor gira, los imanes permanentes inducen una tensión en los devanados, lo que se conoce como fuerza contraelectromotriz (FCEM).

Se trabajará con motores cuyos devanados estén conectados en configuración estrella, ya que se utiliza con mucha más frecuencia que la configuración delta. De todas maneras, es sencillo extender el modelo y el control a motores con conexión delta.


\begin{figure}[H]
	\centering
	\begin{circuitikz}
		% Draw three phases
		\draw (0,0) to [L, l=$L_s$, o-] ++(2,0) to [R, l=$R_s$] ++(2,0) to [sV, v=$e_a$, invert] ++(2,0) -- ++(0,-2){};
		
		\draw (0,-2) to [L, l=$L_s$, o-] ++(2,0) to [R, l=$R_s$] ++(2,0) to [sV, v=$e_b$, invert] ++(2,0) -- ++(0,2);
		
		\draw (0,-4) to [L, l=$L_s$, o-] ++(2,0) to [R, l=$R_s$] ++(2,0) to [sV, v=$e_c$, invert] ++(2,0) -- ++(0,2);
		
		% Draw neutral point
		\draw (6,-2) node[circ]{} -- ++(0.5,0) node[circ]{} node[right]{$N$};
	\end{circuitikz}
	\caption{Circuito eléctrico equivalente de un PMSM trifásico en configuración estrella.}
\end{figure}

\subsection{Representación en el espacio vectorial}

Cuando el PMSM gira, las formas de onda de corriente y voltaje son aproximadamente sinusoidales. Siendo un sistema trifásico y equilibrado, se vería algo como en la siguiente figura.

\begin{figure}[H]
    \centering
    \hspace*{-1.5cm}
    \begin{tikzpicture}
    \begin{axis}[
        width=10cm,
        height=6cm,
        xlabel={Tiempo (s)},
        ylabel={Voltaje (V)},
        legend entries={$v_a$, $v_b$, $v_c$},
        grid=major,  
        legend pos=south east,
        samples=50,
        domain=0:2*360,
        axis line style={draw=none},  % Elimina el recuadro exterior
        xticklabels=\empty,  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    \addplot[blue, thick, domain=0:2*360] {sin(x)};
    \addplot[red, thick, domain=0:2*360] {sin(x - 120)};
    \addplot[green, thick, domain=0:2*360] {sin(x - 240)};
    \end{axis}
    \end{tikzpicture}
    \caption{Sistema trifásico representado en el tiempo.}
\end{figure}

Todas las ecuaciones se pueden definir a partir de este modelo, pero se vuelve muy poco práctico para análisis más complejos. Se introduce una forma de representar estas formas de onda en el espacio tridimensional $\mathbb{R}^3$, en el que se escogen los ejes \((a, b, c)\). Lo que debería esperarse ver es una forma tridimensional en el espacio $\mathbb{R}^3$. Se comienza en \(t = 0\) y se dibuja un punto en las coordenadas \([v_a(0), v_b(0), v_c(0)]\). Luego, se continúa trazando puntos mientras se avanza a lo largo del eje del tiempo. La forma se puede expresar como curva paramétrica como \([v_a(t), v_b(t), v_c(t)]\). Cuando se representa la forma resultante, puede sorprender, ya que es un círculo perfectamente plano. Cabe destacar que el orden de los ejes depende del contexto, y en este trabajo se toma el sistema de referencia mostrado en las siguientes figuras.


\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{3cm}
        \centering
        \hspace*{-1.5cm}
        \begin{tikzpicture}
        \begin{axis}[
            %view={-45}{-35},
            view={-20}{-15},
            %view={54.74}{-15},
            axis lines=none,
            xmin=-1.5,
            xmax=1.5,
            ymin=-1.5,
            ymax=1.5,
            zmin=-1.5,
            zmax=1.5,
            no markers,
            axis equal,
            enlargelimits={upper=0.2},
            scale=1,
        ]
        \addplot3+[red, thick, no markers, samples=30, domain=-pi:pi, variable=\t]
            ({sin(deg(\t))}, {sin(deg(\t + 2*pi/3))}, {sin(deg(\t - 2*pi/3))});
       	
       % Ejes abc
       \draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0.5, 0, 0) node[pos=1.5]{$b$};
       \draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0.5, 0) node[pos=1.5]{$a$};
       \draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0, 0.5) node[pos=1.5]{$c$};
       
       \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, 1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (1.1, 1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, -1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (-1.1, -1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, 1.1) (-1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, 1.1) (1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, 1.1) (1.1, -1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, 1.1) (-1.1, -1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, -1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (-1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (1.1, -1.1, 1.1)};
        \end{axis}
        \end{tikzpicture}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{3cm}
        \centering
            \hspace*{-1.5cm}
            \begin{tikzpicture}
            \begin{axis}[
                view={-45}{-35},
                %view={-20}{-15},
                %view={54.74}{-15},
                axis lines=none,  % Elimina los ejes
                xmin=-.9,
                xmax=.9,
                ymin=-.9,
                ymax=.9,
                zmin=-.9,
                zmax=.9,
                no markers,
                axis equal,
                enlargelimits={upper=0.2},
                scale=1,
            ]
            \addplot3+[red, thick, no markers, samples=30, domain=-pi:pi, variable=\t]
                ({sin(deg(\t))}, {sin(deg(\t + 2*pi/3))}, {sin(deg(\t - 2*pi/3))});
           
           	% Ejes abc
           	\draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0.5, 0, 0) node[pos=1.5]{$b$};
           	\draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0.5, 0) node[pos=1.5]{$a$};
           	\draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0, 0.5) node[pos=1.5]{$c$};
           	
            \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, 1.1, -1.1)};
            \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (1.1, 1.1, -1.1)};
            \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, -1.1, -1.1)};
            \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (-1.1, -1.1, -1.1)};
            \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, 1.1) (-1.1, 1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, 1.1) (1.1, 1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, 1.1) (1.1, -1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, 1.1) (-1.1, -1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, -1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (-1.1, 1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, 1.1, 1.1)};
            \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (1.1, -1.1, 1.1)};
            \end{axis}
            \end{tikzpicture}
    \end{subfigure}
    \hfill
    \begin{subfigure}[b]{3cm}
        \centering
        \hspace*{-1.5cm}
        \begin{tikzpicture}
        \begin{axis}[
            %view={-45}{-35},
            %view={-20}{-15},
            view={54.7356103}{-15},
            axis lines=none,
            xmin=-1.5,
            xmax=1.5,
            ymin=-1.5,
            ymax=1.5,
            zmin=-1.5,
            zmax=1.5,
            no markers,
            axis equal,
            enlargelimits={upper=0.2},
            scale=1,
        ]
        \addplot3+[red, thick, no markers, samples=50, domain=-pi:pi, variable=\t]
            ({sin(deg(\t))}, {sin(deg(\t + 2*pi/3))}, {sin(deg(\t - 2*pi/3))});
        
        % Ejes abc
        \draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0.5, 0, 0) node[pos=1.5]{$b$};
        \draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0.5, 0) node[pos=1.5]{$a$};
        \draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0, 0.5) node[pos=1.5]{$c$};
        
         \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, 1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (1.1, 1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, -1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (-1.1, -1.1, -1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, 1.1) (-1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, 1.1) (1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, 1.1) (1.1, -1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, 1.1) (-1.1, -1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, -1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (-1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, 1.1, 1.1)};
        \addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (1.1, -1.1, 1.1)};
        \end{axis}
        \end{tikzpicture}
    \end{subfigure}   
    \centering
    \caption{Sistema trifásico representado en el Espacio Vectorial.}
\end{figure}


Se puede observar que el sistema trifásico, cuando está equilibrado, se puede representar con solo dos variables, ya que la forma resultante es bidimensional. Se explorará cómo simplificar esto para facilitar el control del PMSM.

\subsection{Transformadas}

Se puede sospechar que lo que se necesita para representar el sistema trifásico con dos variables es un cambio de base, en particular, una rotación. El enfoque general sería utilizar la transformada de Concordia. La transformada de Clarke es el caso particular para 3 dimensiones de la transformada de Concordia, que se utiliza para cualquier número de dimensiones.

Se pueden encontrar dos transformadas de Clarke: la transformada de Clarke ortonormal y la transformada de Clarke de amplitud constante o módulo invariante. Además, se pueden considerar el eje $\alpha$ avanzado 90º respecto al eje $\beta$, o viceversa. Para el análisis y control de una máquina eléctrica se suele utilizar la transformada de Clarke de amplitud constante con $\alpha$ avanzada.

\subsubsection{Transformada de Clarke ortonormal}

Esta transformada se utiliza cuando la potencia del sistema debe permanecer inalterada después de la transformación. Se aplican dos rotaciones al marco de referencia $abc$ y se crea el marco de referencia $\alpha\beta\gamma$. En este nuevo marco de referencia, la trayectoria del vector espacial está completamente contenida en el plano $\alpha\beta$ cuando el sistema está equilibrado, y el eje $\gamma$ se utiliza para explicar el componente homopolar del sistema (la suma de los tres componentes debe ser igual a 0 si el sistema está equilibrado, de lo contrario, aparece el componente homopolar).

\begin{figure}[H]
	\centering
	\hspace*{-1.5cm}
	\begin{tikzpicture}
		\begin{axis}[
			view={-45}{-35},
			%view={-20}{-15},
			%view={54.74}{-15},
			axis lines=none,  % Elimina los ejes
			xmin=-.9,
			xmax=.9,
			ymin=-.9,
			ymax=.9,
			zmin=-.9,
			zmax=.9,
			no markers,
			axis equal,
			enlargelimits={upper=0.2},
			scale=1,
			]
			\addplot3+[red, thick, no markers, samples=30, domain=-pi:pi, variable=\t]
			({sin(deg(\t))}, {sin(deg(\t + 2*pi/3))}, {sin(deg(\t - 2*pi/3))});
			
			% Ejes abc
			\draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0.5, 0, 0) node[pos=1.5]{$b$};
			\draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0.5, 0) node[pos=1.5]{$a$};
			\draw[red, line width=1.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0, 0.5) node[pos=1.5]{$c$};
			
			% Ejes alpha-beta
			\draw[blue, line width=0.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:0, 0.7, 0) node[pos=1.5]{$\alpha$};
			\draw[blue, line width=0.5pt, -{Latex[length=1.5mm,width=1mm]}] (axis cs:0, 0, 0) -- (axis cs:1, 0.7, 0.3) node[pos=1.5]{$\beta$};

			\addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, 1.1, -1.1)};
			\addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (1.1, 1.1, -1.1)};
			\addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, -1.1, -1.1)};
			\addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (-1.1, -1.1, -1.1)};
			\addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, 1.1) (-1.1, 1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, 1.1) (1.1, 1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, 1.1) (1.1, -1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, 1.1) (-1.1, -1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(-1.1, -1.1, -1.1) (-1.1, -1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(-1.1, 1.1, -1.1) (-1.1, 1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(1.1, 1.1, -1.1) (1.1, 1.1, 1.1)};
			\addplot3[draw=gray, no markers] coordinates {(1.1, -1.1, -1.1) (1.1, -1.1, 1.1)};
		\end{axis}
	\end{tikzpicture}
	\centering
	\caption{Sistema trifásico representado en el Espacio Vectorial con la transformada de Clarke ortonormal superpuesta.}
	\end{figure}




No se derivará la transformada aquí, aunque es necesario comprender lo que hace y conocer la matriz de transformación.

Lo que hace la transformada es colocar dos de los ejes del sistema de referencia en el plano formado por el círculo generado por el vector espacial. El eje restante es perpendicular a ese plano y representa el componente homopolar.

A continuación se presenta la forma matricial de la transformada:

\begin{equation}
    \begin{bmatrix}
        \alpha \\
        \beta \\
        \gamma
    \end{bmatrix}
    =
    \sqrt{\frac{2}{3}}
    \begin{bmatrix}
        1 & -\frac{1}{2} & -\frac{1}{2} \\
        0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
        \frac{1}{\sqrt{2}} & \frac{1}{\sqrt{2}} & \frac{1}{\sqrt{2}}
    \end{bmatrix}
    \begin{bmatrix}
        a \\
        b \\
        c
    \end{bmatrix}
\end{equation}

La forma matricial de la transformada inversa es:

\begin{equation}
    \begin{bmatrix}
        a \\
        b \\
        c
    \end{bmatrix}
    =
    \sqrt{\frac{2}{3}}
    \begin{bmatrix}
        1 & 0 & \frac{1}{\sqrt{2}} \\
        -\frac{1}{2} & \frac{\sqrt{3}}{2} & \frac{1}{\sqrt{2}} \\
        -\frac{1}{2} & -\frac{\sqrt{3}}{2} & \frac{1}{\sqrt{2}}
    \end{bmatrix}
    \begin{bmatrix}
        \alpha \\
        \beta \\
        \gamma
    \end{bmatrix}
\end{equation}

Esta transformada tiene la particularidad de mantener constante la potencia del sistema, de modo que se cumple la siguiente condición:

\begin{equation}
p(t) = p_{abc} = p_{\alpha\beta\gamma, \text{ortonormal}} = v_a \cdot i_a + v_b \cdot i_b + v_c \cdot i_c = v_\alpha \cdot i_\alpha + v_\beta \cdot i_\beta + v_\gamma \cdot i_\gamma
\end{equation}

\subsubsection{Transformada de Clarke de Amplitud Constante}

Mantener constante la potencia a lo largo de las transformadas puede ser útil en algunos contextos, pero lo que se suele implementar es una variante de la transformada de Clarke que mantiene constante la amplitud de la magnitud.

La transformada no es ortonormal, ya que ajusta las magnitudes para que el módulo de las variables sea el adecuado, pero la rotación se mantiene igual.

\begin{equation}
    \begin{bmatrix}
        \alpha' \\
        \beta' \\
        \gamma'
    \end{bmatrix}
    =
    \frac{2}{3}
    \begin{bmatrix}
        1 & -\frac{1}{2} & -\frac{1}{2} \\
        0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
        \frac{1}{2} & \frac{1}{2} & \frac{1}{2}
    \end{bmatrix}
    \begin{bmatrix}
        a \\
        b \\
        c
    \end{bmatrix}
\end{equation}

La transformada inversa es la siguiente:

\begin{equation}
    \begin{bmatrix}
        a \\
        b \\
        c
    \end{bmatrix}
    =
    \begin{bmatrix}
        1 & 0 & 1 \\
        -\frac{1}{2} & \frac{\sqrt{3}}{2} & 1 \\
        -\frac{1}{2} & -\frac{\sqrt{3}}{2} & 1
    \end{bmatrix}
    \begin{bmatrix}
        \alpha' \\
        \beta' \\
        \gamma'
    \end{bmatrix}
\end{equation}

Se puede derivar que:

\begin{equation}
p_{abc} = \frac{3}{2} \cdot (v_{\alpha'} \cdot i_{\alpha'} + v_{\beta'} \cdot i_{\beta'} + v_{\gamma'} \cdot i_{\gamma'})
\end{equation}


\subsubsection{Transformada de Park}

Después de aplicar la transformada de Clarke, todavía quedan dos variables sinusoidales (\(\alpha\beta\) si se considera \(\gamma = 0\)), lo que dificulta el análisis para que el control sea sencillo. Por lo tanto, se aplica otra transformada para convertir estas cantidades sinusoidales en constantes.

Ahora, considerando que el vector espacial gira a una velocidad de \(\omega = 2\pi f\), si se aplica continuamente una rotación alrededor del eje \(\gamma\) con un ángulo \(\theta = \omega  t\), se puede representar el vector espacial como una composición de dos variables continuas (en lugar de sinusoides). Además, si se sincroniza esta rotación con el ángulo del vector espacial (el eje \(d\) apuntando al vector espacial), se obtiene una variable continua (\(d\)) y una segunda variable de valor nulo (\(q\)).

\begin{figure}[H]
  \centering
  %\includegraphics[width=0.5\textwidth]{ruta_de_la_imagen_en_formato_latex}
  \caption{Transformada de Park.}
\end{figure}

Se puede ver que la transformada es simplemente una rotación a lo largo de uno de los ejes de la base:

\begin{equation}
    \begin{bmatrix}
        d \\
        q \\
        0
    \end{bmatrix}
    =
    \begin{bmatrix}
        \cos(\theta) & \sin(\theta) & 0 \\
        -\sin(\theta) & \cos(\theta) & 0 \\
        0 & 0 & 1
    \end{bmatrix}
    \begin{bmatrix}
        \alpha \\
        \beta \\
        \gamma
    \end{bmatrix}
\end{equation}

\subsection{Marco de referencia rotatorio}

En esta sección, se convertirá el modelo trifásico inicial del PMSM en un modelo continuo en el marco de referencia $d - q$. Antes, se omitieron las ecuaciones del modelo trifásico, pero utilizando estas y aplicando las transformadas de Clarke y Park, se obtienen las ecuaciones que se derivarán en esta sección.

El enfoque general es utilizar la transformada de amplitud constante, lo que lleva a estas ecuaciones para las tensiones y corrientes del estator:

\begin{equation}
	\begin{bmatrix}
		v_d \\
		v_q \\
		v_0
	\end{bmatrix}
	=
	\begin{bmatrix}
		\cos(\theta) & \sin(\theta) & 0  \\
		-\sin(\theta) & \cos(\theta) & 0  \\
		0 & 0 & 1
	\end{bmatrix}
	\frac{2}{3}
	\begin{bmatrix}
		1 & -\frac{1}{2} & -\frac{1}{2} \\
		0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
		\frac{1}{2} & \frac{1}{2} & \frac{1}{2}
	\end{bmatrix}
	\begin{bmatrix}
		v_a \\
		v_b \\
		v_c
	\end{bmatrix}
\end{equation}

\begin{equation}
	\begin{bmatrix}
		i_d \\
		i_q \\
		i_0
	\end{bmatrix}
	=
	\begin{bmatrix}
		\cos(\theta) & \sin(\theta) & 0  \\
		-\sin(\theta) & \cos(\theta) & 0  \\
		0 & 0 & 1
	\end{bmatrix}
	\frac{2}{3}
	\begin{bmatrix}
		1 & -\frac{1}{2} & -\frac{1}{2} \\
		0 & \frac{\sqrt{3}}{2} & -\frac{\sqrt{3}}{2} \\
		\frac{1}{2} & \frac{1}{2} & \frac{1}{2}
	\end{bmatrix}
	\begin{bmatrix}
		i_a \\
		i_b \\
		i_c
	\end{bmatrix}
\end{equation}

El modelo de circuito equivalente se divide en los circuitos del eje $d$ y el eje $q$:


\begin{figure}[H]
	\centering
	\begin{minipage}{0.45\textwidth}
		\centering
		\begin{circuitikz}[american voltages]
			% d-axis circuit
			\draw (0,0) to [L, l=$L_d$, o-] ++(2,0) to [R, l=$R_s$] ++(2,0) to [V, v^=$\omega_e\cdot L_q\cdot i_q$, invert] ++(2,0) -- ++(0,-2){};
			% Parallel line
			\draw (0,-2) node[circ, fill=none]{} -- ++(6,0);
			% Current label
			\draw (4,-2) to [open, i_=$i_d$] (2,-2);
			% Voltage labels
			\draw (0,0) to [open, v^=$v_d$] (0,-2);
		\end{circuitikz}
	\end{minipage}
	\hspace{0.05\textwidth}
	\begin{minipage}{0.45\textwidth}
		\centering
		\begin{circuitikz}[american voltages]
			% q-axis circuit
			\draw (0,0) to [L, l=$L_q$, o-] ++(2,0) to [R, l=$R_s$] ++(2,0) to [V, v^=$\omega_e\cdot L_d\cdot i_d$] ++(2,0) to [V, v^=$\omega_e \lambda_m$] ++(0,-2){};
			% Parallel line
			\draw (0,-2) node[circ, fill=none]{} -- ++(6,0);
			% Current label
			\draw (4,-2) to [open, i_=$i_q$] (2,-2);
			% Voltage labels
			\draw (0,0) to [open, v^=$v_q$] (0,-2);
		\end{circuitikz}
	\end{minipage}
	\caption{Circuitos eléctricos equivalentes del modelo $d-q$ de un PMSM.}
\end{figure}

Se puede observar que:

\begin{equation}
v_d = v_{R_s} - \omega_e \cdot L_q \cdot i_q + v_{L_d}
\end{equation}

\begin{equation}
v_d = R_s\cdot i_d - \omega_e \cdot L_q \cdot i_q + L_d\cdot\frac{d i_d}{d t}
\end{equation}

Y:

\begin{equation}
v_q = v_{R_s} - \omega_e \cdot L_d \cdot i_d + \omega_e \cdot \lambda_m + v_{L_q}
\end{equation}

\begin{equation}
v_q = R_s\cdot i_q - \omega_e \cdot L_d \cdot i_q + \omega_e \cdot \lambda_m + L_q\cdot\frac{d i_q}{d t}
\end{equation}

Donde:
\begin{itemize}
    \item \(v_d\) y \(v_q\) son las tensiones en los ejes d y q respectivamente.
    \item \(i_d\) y \(i_q\) son las corrientes en los ejes d y q respectivamente.
    \item \(L_d\) y \(L_q\) son las inductancias en los ejes d y q respectivamente.
    \item \(\omega_e\) es la velocidad eléctrica, que es la velocidad mecánica multiplicada por el número de pares de polos del PMSM (\(\omega_e = \omega_m \cdot pp = \omega_m \cdot \frac{n}{2}\)).
    \item \(\lambda_m\) es el flujo magnético generado por los imanes permanentes. La magnitud del flujo magnético generado afecta directamente la magnitud de la tensión inducida en las fases del estator. Este parámetro se puede transformar fácilmente en \(k_E\), que es la relación entre la velocidad mecánica del rotor y la tensión generada en las 3 fases.
\end{itemize}


Hay PMSM cuyos imanes están montados dentro del rotor (IPM) y otros cuyos imanes están en la superficie del rotor (SPM). Esta diferenciación juega un papel importante en el desarrollo del modelo y el control, porque en los SPM se cumple \(L_d = L_q\), a menudo escrito solo como \(L\). Además, si se trata de un IPM, la orientación de los imanes puede cambiar las trayectorias del control, de manera que si son imanes tangenciales se da \(L_d > L_q\) y si son imanes radiales \(L_d < L_q\). Se desarrollarán las ecuaciones para motores IPM con imanes radiales, pero se ha de tener en cuenta que se pueden realizar muchas simplificaciones si el motor es un SPM. Una situación que se dará es que algunas ecuaciones tienen alguna forma de \(L_d - L_q\) como denominador, lo cual es bastante problemático si se está tratando de implementar la ecuación directamente. Por ese motivo, es mejor diferenciar el tipo de motor antes de implementar las ecuaciones. Una solución válida es tener en cuenta la anisotropía magnética que suelen presentar la mayoría de SPMs, con lo que \(L_d < L_q\) y se pueden aplicar las ecuaciones del IPM a costa de potencia de cálculo, de ejecutarse el control en tiempo real.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/motor-types}
	\caption{Tipos de PMSMs según la disposición de los imanes. a) SPM, b) IPM radial, c) IPM tangencial.}
\end{figure}


La potencia eléctrica se define como:

\begin{equation}
p_e = \frac{3}{2}\cdot(v_d i_d + v_q i_q)
\end{equation}

Si se supone que la máquina es perfectamente eficiente, se puede decir que la potencia mecánica es igual a la potencia eléctrica, \(p_e = p_m\). Sabiendo que \(p_m = \omega_m T_{em}\), donde \(T_{em}\) es el par electromagnético producido, se puede derivar:

\begin{equation}
T_{em} = \frac{3}{2\cdot \omega_m}\cdot(v_d i_d + v_q i_q) = \frac{3}{2\cdot \omega_e}\frac{n}{2}\cdot(v_d i_d + v_q i_q)
\end{equation}

\begin{equation}
T_{em} = \frac{3}{2}\frac{n}{2}\cdot((L_d - L_q) i_q i_d + \lambda_m i_q)
\end{equation}

También se puede establecer un límite de voltaje, porque el PMSM generalmente se controla con un inversor de fuente de voltaje (VSI) modulado por SVPWM y la tensión de salida está limitada a \(\frac{V_{DC}}{\sqrt{3}}\). En esta ecuación, no se considera la caída de tensión por la resistencia del estator \(R_s\), ya que haría que las ecuaciones fueran muy densas y el efecto de esta caída de voltaje es despreciable a altas velocidades.

\begin{equation}
\left(\frac{\frac{V_{DC}}{\sqrt{3}}}{\omega_e}\right)^2 \geq \left(\lambda_m+L_d\cdot i_d\right)^2+(L_q\cdot i_q)^2
\end{equation}

\subsection{Curvas características del PMSM}

Las ecuaciones del PMSM son muy útiles cuando se diseña el control y la implementación real, pero antes de eso, es muy recomendable verlas en un gráfico para comprender mejor algunas de las intuiciones detrás de ellas.

\subsubsection{Curva de par-velocidad y potencia-velocidad}

Las primeras curvas estudiadas son las de par-velocidad y potencia-velocidad. Definen la intención de diseño del PMSM, ilustrando el rendimiento deseado. El objetivo al diseñar el control es tratar de igualar o incluso superar estas curvas.


\begin{figure}[H]
    \centering
    \hspace*{-1.5cm}
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=10cm,
        height=8cm,
        x label style={at={(axis description cs:-0.1,0.5)},anchor=north},
        y label style={at={(axis description cs:0.5,-0.1)},rotate=90,anchor=south},
        xlabel={$\omega_m$},
        ylabel={$T_{em}$},
        ytick={-26, 26},
        xtick={-2000,-1000,1000,2000},
        yticklabels={$-T_{em,max}$, $T_{em,max}$},
        xticklabels={$-\omega_{m,max}$, $-\omega_{m,nom}$, $\omega_{m,nom}$,$\omega_{m,max}$},
        grid=none,  
        ymin=-40,
        ymax=40,
        samples=15,
        domain=-2500:2500,
        nodes near coords align={south east},
        y tick label style={yshift={sign(\tick)*10}},
        ylabel style={rotate=-90},
        %no marks
        % axis line style={draw=none},  % Elimina el recuadro exterior
    ]
    \addplot[blue, thick, domain=-1000:1000] {26};
    \addplot[blue, thick, domain=-1000:1000] {-26};
    \addplot[blue, thick, domain=1000:2500] {26000/x};
    \addplot[blue, thick, domain=-2500:-1000] {-26000/x};
    \addplot[white, line width=1mm, domain=2000:2500] {26000/x};
    \addplot[white, line width=1mm, domain=-2500:-2000] {-26000/x};
    \addplot[blue, thick, domain=1000:2500] {-26000/x};
    \addplot[blue, thick, domain=-2500:-1000] {26000/x};
    \addplot[white, line width=1mm, domain=2000:2500] {-26000/x};
    \addplot[white, line width=1mm, domain=-2500:-2000] {26000/x};
    \end{axis}
    \end{tikzpicture}
    \caption{Curva de par-velocidad del PMSM.}
\end{figure}


La curva es una función por tramos, que toma \(T_{em,max}\), \(\omega_{m,max}\) y \(P_{m,max}\) como sus parámetros.

La curva es constante desde \(\omega_m = 0\) hasta \(\omega_m = \omega_{m,nom} = \frac{P_{m,max}}{T_{em,max}}\), donde su valor es \(T_{em,max}\). Esta porción es lo que se conoce como la zona de par constante. Desde \(\omega_m = \omega_{m,nom}\) hasta \(\omega_m = \omega_{m,max}\), \(T_{em}\) se define como \(T_{em} = \frac{P_{m,max}}{\omega_m}\), lo que da una curva de tipo \(y=\frac{a}{x}\). Esto se llama la zona de potencia constante.

\[
T_{em} = 
\begin{cases}
  T_{em,max} & -\omega_{m,nom} < \omega_m < \omega_{m,nom} \\
  -T_{em,max} & -\omega_{m,nom} < \omega_m < \omega_{m,nom} \\
  \frac{P_{m,max}}{\omega_m} & \omega_{m,nom}\leq \omega_m\leq \omega_{m,max} (T_{em,max}),-\omega_{m,max}\leq \omega_m\leq -\omega_{m,nom} (-T_{em,max})\\
  -\frac{P_{m,max}}{\omega_m} & \omega_{m,nom}\leq \omega_m\leq \omega_{m,max} (-T_{em,max}),-\omega_{m,max}\leq \omega_m\leq -\omega_{m,nom} (T_{em,max})
\end{cases}
\]

Además \(P_m\) aumentará linealmente con \(\omega_m\) hasta \(\omega_{m,nom}\), ya que \(P_m = T_{em} \cdot \omega_m\). Desde \(\omega_{m,nom}\) hasta \(\omega_{m,max}\), \(P_m\) es una recta de valor \(P_{m,max}\)

\begin{figure}[H]
	\centering
	\hspace*{-1.5cm}
	\begin{tikzpicture}
		\begin{axis}[
			axis lines=middle,
			width=10cm,
			height=8cm,
			x label style={at={(axis description cs:-0.1,0.5)},anchor=north},
			y label style={at={(axis description cs:0.5,-0.1)},rotate=90,anchor=south},
			xlabel={$\omega_m$},
			ylabel={$P_{em}$},
			ytick={-26, 26},
			xtick={-2000,-1000,1000,2000},
			yticklabels={$-P_{m,max}$, $P_{m,max}$},
			xticklabels={$-\omega_{m,max}$, $-\omega_{m,nom}$, $\omega_{m,nom}$,$\omega_{m,max}$},
			grid=none,  
			ymin=-40,
			ymax=40,
			samples=15,
			domain=-2500:2500,
			nodes near coords align={south east},
			y tick label style={yshift={sign(\tick)*10}},
			ylabel style={rotate=-90},
			%no marks
			% axis line style={draw=none},  % Elimina el recuadro exterior
			]
			\addplot[blue, thick, domain=-1000:1000] {x*26/1000};
			\addplot[blue, thick, domain=-1000:1000] {-x*26/1000};
			\addplot[blue, thick, domain=1000:2500] {26};
			\addplot[blue, thick, domain=-2500:-1000] {-26};
			\addplot[white, line width=1mm, domain=2000:2500] {26};
			\addplot[white, line width=1mm, domain=-2500:-2000] {-26};
			\addplot[blue, thick, domain=1000:2500] {-26};
			\addplot[blue, thick, domain=-2500:-1000] {26};
			\addplot[white, line width=1mm, domain=2000:2500] {-26};
			\addplot[white, line width=1mm, domain=-2500:-2000] {26};
		\end{axis}
	\end{tikzpicture}
	\caption{Curva de potencia-velocidad del PMSM.}
\end{figure}


\subsubsection{CLC (Círculo de límite de corriente)}

Es obvio que la corriente eléctrica suministrada al PMSM debe estar limitada. Por lo general, el fabricante del motor establecerá la corriente alterna máxima, lo cual se traduce en un límite para \(i_d\) y \(i_q\).

A continuación, se presenta un gráfico muy útil para conocer los límites del motor. Se establecen los ejes como $i_d$ e $i_q$. Por ejemplo, si un motor está funcionando con $i_d = -1 \, \text{A}$ e $i_q = 5 \, \text{A}$, se dibuja un punto en $(-1,5)$. Como se puede apreciar, este es un sistema de coordenadas cartesianas. También puede convertirse en un sistema de coordenadas polares, que utiliza una magnitud y un ángulo. La magnitud del vector será entonces:
\begin{equation}
I_{s} = \sqrt{i_d^2+i_q^2} [\text{A}]
\end{equation}

Y el ángulo:

\begin{equation}
\gamma = \arctan\left(\frac{i_q}{i_d}\right) [\text{rad}]
\end{equation}

Se puede observar que la corriente máxima puede expresarse más fácilmente como $I_s$, independientemente del ángulo $\gamma$ (no debe confundirse con el $\gamma$ de la transformada de Clarke). Por lo tanto, se puede representar $I_s = I_{s,\text{max}} , \forall \gamma \in [0,2\pi]$

\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		\begin{axis}[
			axis lines=middle,
			width=6cm,
			height=8cm,
			xlabel={$i_d$},
			x label style={at={(axis description cs:0.05,0.6)},anchor=north},
			ylabel={$i_q$},
			grid=none,
			xmin=-1.2,
			xmax=0.4,
			ymin=-1.2,
			ymax=1.2,
			no markers,
			x axis line style={stealth-},
			xticklabels=\empty,
			yticklabels=\empty,
			clip=false,          % Disable clipping
			]
			
			% Límite de corriente Is_max
			\draw [red, thick] (0.4,0.693) arc (60:300:0.8);
			\draw [red, -stealth](0,0) -- (-0.56568542494,0.56568542494) node at (-1,0.56568542494) {$I_s = I_{s,\text{max}}$};
			\draw [white, thick] (axis cs: 0.2, 0) arc (0:180:0.2);
			\draw [red, thick] (axis cs: 0.2, 0) arc (0:135:0.2);
			\node [red] at (axis cs: 0.25, 0.28) {$\gamma = \frac{3\pi}{4}$};
			
		\end{axis}
	\end{tikzpicture}
  \caption{Círculo de límite de corriente.}
\end{figure}


Resulta ser un círculo, lo cual tiene sentido, ya que es un vector de magnitud constante. Además, el vector de corriente $I_s\angle \gamma = I_{s,\text{max}} \angle{\frac{3\pi}{4}}$ se representa para facilitar su comprensión.


\subsubsection{TH (Hipérbolas de par)}

Si se estudia la ecuación del par, es evidente que \(T_{em}\) es una función de \((i_d, i_q)\). El resto de parámetros son constantes, por lo que se puede establecer un valor fijo de par y deslizar alrededor de \((i_d, i_q)\) para generar una curva. La forma de la curva resultante es una hipérbola.

\begin{equation}
T_{em} = \frac{3}{2}pp\cdot((L_d - L_q)\cdot I_s^2 \cdot \sin(\gamma)\cos(\gamma) + \lambda_m\cdot I_s\cdot \sin(\gamma))
\end{equation}




\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xticklabels=\empty,  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    \draw[black] (0,0) circle [radius=0.8];
    \addplot[red, thick, domain=-1.2:0.4] {4*0.1/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {4*0.4/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {4*0.7/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {4*0.98/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    
    \addplot[red, thick, domain=-1.2:0.4] {-4*0.1/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {-4*0.4/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {-4*0.7/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {-4*0.98/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    

    \end{axis}
    \end{tikzpicture}
  \caption{Hipérbolas de par.}
\end{figure}


El gráfico se limita a los cuadrantes 2 y 3 por un motivo ilustrado con estas hipérbolas: solo los valores negativos de \(i_d\) contribuyen a la generación de par. Cuando \(i_d>0\), se necesita más corriente para generar la misma cantidad de par. Cuanto más alejada está la hipérbole del eje \(i_d\), más par representa en valor absoluto. Aquellas hipérbolas que quedan por encima del eje \(i_d\), es decir, \(i_q > 0\) son par positivo, mientras que si \(i_q < 0\), el par es de sentido opuesto.

\subsubsection{VLE (Elipses de límite de voltaje)}

Tomando la ecuación de voltaje presentada anteriormente, se puede demostrar que es una elipse. Del mismo modo que con las hipérbolas de par, se pueden establecer una velocidad y una tensión, y deslizar valores de \((i_d, i_q)\) para generar la curva.

\begin{equation}
1 \geq \frac{\left(\frac{\lambda_m}{L_d}+i_d\right)^2}{\left(\frac{\frac{V_{DC}}{\sqrt{3}}}{L_d\omega_e}\right)^2}+\frac{i_q^2}{\left(\frac{\frac{V_{DC}}{\sqrt{3}}}{L_q\omega_e}\right)^2}
\end{equation}




\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xtick = {-1},
        xticklabels={$-\frac{\lambda_m}{L_d}$},  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    
    \draw[black] (0,0) circle [radius=0.8];
    \draw[red, thick] (-1,0) ellipse (1.333333 and 0.66666666);
    \draw[red, thick] (-1,0) ellipse (0.8 and 0.4);
    \draw[red, thick] (-1,0) ellipse (0.5 and 0.25);

    \end{axis}
    \end{tikzpicture}
  \caption{Elipses de límite de voltaje con $I_{sc} > I_{s,max}$.}
\end{figure}


Al representar estas elipses, normalmente se anotan los valores de velocidad en rpm mecánicas, ya que es mucho más fácil hacerse una idea de los límites del motor junto al resto de curvas (\(\omega_m \, [\text{rpm}] = \frac{1}{pp} \omega_e \left[\frac{\text{rad}}{s}\right] \cdot \frac{60}{2\pi}\)).

Las elipses se reducen a medida que la velocidad aumenta. El foco de las elipses está ubicado exactamente en \((i_d, i_q)=(-I_{sc}, 0) = \left(-\frac{\lambda_m}{L_d},0\right)\). En el gráfico anterior, el foco está fuera del círculo de límite de corriente, pero no siempre es el caso. Si \(I_{sc} \leq I_{s,max}\), teóricamente el motor puede alcanzar una velocidad infinita, ya que las elipses colapsan en un solo punto. 



\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xtick = {-0.6},
        xticklabels={$-\frac{\lambda_m}{L_d}$},  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    
    \draw[black] (0,0) circle [radius=0.8];
    \draw[red, thick] (-0.6,0) ellipse (1.333333 and 0.66666666);
    \draw[red, thick] (-0.6,0) ellipse (0.8 and 0.4);
    \draw[red, thick] (-0.6,0) ellipse (0.5 and 0.25);

    \end{axis}
    \end{tikzpicture}
  \caption{Elipses de límite de voltaje con $I_{sc} \leq I_{s,max}$.}
\end{figure}




%% HASTA AQUI TRACUCCION POCHA DE LA WIKI

\section{Control del PMSM en el espacio d-q}
\subsection{Trayectorias de control}

Después de conocer los límites de la máquina, se pueden establecer criterios para decidir cuánto \(i_d\) y \(i_q\) (o \(I_s\) y \(\gamma\)) se deben aplicar al PMSM para que se comporte mecánicamente como se desee. El conjunto de puntos de trabajo que definen un comportamiento se llama trayectoria y existen una multitud de ellas. Por ejemplo, se puede desear que el motor produzca la mayor cantidad de par posible con la mínima corriente. Pero también se podría querer que tenga un cierto factor de potencia o que mantenga el par constante subiendo la velocidad, etc.

En un monoplaza de Formula Student, se desea que la salida de par esté perfectamente controlada y conocida para que el algoritmo de dinámica vehicular pueda estimar correctamente las fuerzas en los neumáticos. También es deseable que el motor pueda girar más rápido cuando no se requiere más par, ya que no es necesaria mucha tracción a altas velocidades del vehículo. Además, es necesario que sea eficiente para aprovechar mejor la energía de la batería. Con estos requisitos en mente, se estudian 4 trayectorias de control adecuadas para esta aplicación.

\subsubsection{MTPA (Máximo Par por Amperio)}

La trayectoria de control más utilizada es el MTPA, o Máximo Par por Amperio. Como su nombre indica, minimiza la corriente para entregar un par determinado. La condición que se debe cumplir es:

\begin{equation}
	\frac{\partial T_{em}}{\partial \gamma} = 0
\end{equation}


La expresión analítica se desarrolla como:

\begin{equation}
	T_{em} = \frac{3}{2}pp\cdot((L_d - L_q)\cdot I_s^2 \cdot \sin(\gamma)\cos(\gamma) + \lambda_m\cdot I_s\cdot \sin(\gamma))
\end{equation}


\begin{equation}
\frac{\partial T_{em}}{\partial \gamma} = \frac{\partial}{\partial \gamma} \frac{3}{2}pp\cdot(I_s^2 \cos(\gamma)\sin(\gamma)\cdot((L_d - L_q) + \lambda_m I_s \sin(\gamma)) = 0
\end{equation}

\begin{equation}
I_{s,\text{MTPA}} = -\frac{\lambda_m \cos(\gamma)}{(2\cdot\cos(\gamma)^2 - 1)\cdot(L_d-L_q)}
\end{equation}

Para la aplicación de esta trayectoria en el control se busca el ángulo como función de la corriente, y para ello se debe despejar \(\gamma_{MTPA}\) de la expresión.

\begin{equation}
\gamma_{\text{MTPA}} = \frac{\pi}{2} + \arcsin(\frac{\lambda_m \pm \sqrt{8(L_d-L_q)^2 \cdot I_s^2 + \lambda_m^2}}{4\cdot I_s(L_d-L_q)})
\end{equation}

El resultado de graficar esta expresión sobre el plano \((i_d, i_q)\) deja a la vista que el módulo de corriente es mínimo para cada hipérbola de par.


\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xticklabels=\empty,  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    \draw[black] (0,0) circle [radius=0.8];
    \addplot[black, domain=-1.2:0.4] {4*0.4/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {4*0.7/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {4*0.98/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    
    \addplot[black, domain=-1.2:0.4] {-4*0.4/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {-4*0.7/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {-4*0.98/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    
    \addplot[red, thick, domain=-0.4:0] {sqrt(((2/3)*x+(2/3)*(1-2)*x^2)/((2/3)*(1-2))))};
    \addplot[red, thick, domain=-0.4:0] {-sqrt(((2/3)*x+(2/3)*(1-2)*x^2)/((2/3)*(1-2))))};


    \end{axis}
    \end{tikzpicture}
  \caption{Trayectoria MTPA.}
\end{figure}


\subsubsection{CTC (Curva de Torque Constante)}

Como se puede observar, las hipérbolas de torque definen una trayectoria la cual permite mantener un par constante. Recordando las elipses de tensión, para un mismo valor de $V_s$ las elipses se contraen hacia el foco a medida que la velocidad aumenta. Esto significa que siguiendo la curva de torque constante de derecha a izquierda se puede mantener el par aumentando la velocidad. Usando la expresión del torque se puede obtener directamente:
\begin{equation}
	T_{em} = \frac{3}{2}pp\cdot((L_d - L_q)\cdot I_s^2 \cdot \sin(\gamma)\cos(\gamma) + \lambda_m\cdot I_s\cdot \sin(\gamma))
\end{equation}

\begin{equation}
I_{s,\text{CTC}} = \frac{\lambda_m}{L_d} \cdot \frac{\sqrt{\sin(\gamma)^2+\frac{2\cdot\frac{L_d-L_q}{L_d}\cdot\sin(2\gamma)\cdot T_{em}\cdot2 L_d}{3\cdot pp \cdot \lambda_m^2}}-\sin(\gamma)}{\sin(2\gamma)\cdot(\frac{L_d-L_q}{L_d})}
\end{equation}



\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xticklabels=\empty,  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    \draw[black] (0,0) circle [radius=0.8];
    \addplot[black, domain=-1.2:0.4] {4*0.4/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[red, thick, domain=-1.2:0.4] {4*0.7/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {4*0.98/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    
    \addplot[black, domain=-1.2:0.4] {-4*0.4/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {-4*0.7/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    \addplot[black, domain=-1.2:0.4] {-4*0.98/(3*2*((2/3)+(2/3)/1*(1-2)*x))};
    
    \end{axis}
    \end{tikzpicture}
  \caption{Trayectoria CTC.}
\end{figure}


\subsubsection{MTPV (Máximo Par por Voltio)}

Existe una trayectoria que permite maximizar el par entregado por el motor en rangos de velocidad muy altos donde el límite es la tensión que puede sintetizar la controladora. La condición que se debe cumplir es:

\begin{equation}
\frac{\partial T_{em}}{\partial \delta} = 0
\end{equation}

Donde $\delta$ es el ángulo del vector de tensión $V_s$. La expresión analítica se desarrolla como:

\begin{equation}
T_{em} = \frac{3}{2}pp\cdot((L_d - L_q) i_q i_d + \lambda_m i_q)
\end{equation}

Se neglige la caída de tensión resistiva del estator. 
\begin{equation}
i_d = \frac{v_q}{\omega_e \cdot L_d} - \frac{\lambda_m}{L_d}; i_q = -\frac{v_d}{\omega_e \cdot L_q}
\end{equation}

\begin{equation}
T_{em} = \frac{3}{2}pp\cdot\left((L_d - L_q) (-\frac{v_d}{\omega_e \cdot L_q}) (\frac{v_q}{\omega_e \cdot L_d} - \frac{\lambda_m}{L_d}) + \lambda_m (-\frac{v_d}{\omega_e \cdot L_q})\right)
\end{equation}

\begin{equation}
T_{em} = \frac{3}{2}pp\cdot\left((L_d - L_q) (-\frac{V_s \cdot \cos(\delta)}{\omega_e \cdot L_q}) (\frac{V_s \cdot \sin(\delta)}{\omega_e \cdot L_d} - \frac{\lambda_m}{L_d}) + \lambda_m (-\frac{V_s \cdot \cos(\delta)}{\omega_e \cdot L_q})\right)
\end{equation}

\begin{equation}
\begin{split}
\frac{\partial T_{em}}{\partial \delta} = \frac{3}{2}pp\cdot (
(L_d - L_q) \cdot (\frac{V_s \cdot \sin(\delta)}{\omega_e \cdot L_q}) \cdot (\frac{V_s \cdot \sin(\delta)}{\omega_e \cdot L_d} - \frac{\lambda_m}{L_d})\\
-\left(\frac{V_s \cdot \cos(\delta)}{\omega_e}\right)^2 \cdot \frac{L_d - L_q}{L_d\cdot L_q}\\ 
-\frac{\lambda_m \cdot V_s \cdot \sin(\delta)}{L_q \cdot \omega_e} ) = 0
\end{split}
\end{equation}


\begin{equation}
\begin{split}
I_{s,MTPV} = \frac{\lambda_m}{L_d} ( \frac{-(2 - \frac{L_q}{L_d}) \cos(\gamma)}{2(1 - \frac{L_q}{L_d})(1 + (\frac{L_q}{L_d})^2) \cos(\gamma)^2 - 2(1 - \frac{L_q}{L_d}) (\frac{L_q}{L_d})^2}\\
-\frac{\sqrt{(2 - \frac{L_q}{L_d})^2 \cos(\gamma)^2 - 4(1 - \frac{L_q}{L_d})(1 + (\frac{L_q}{L_d})^2) \cos(\gamma)^2 - 4(1 - \frac{L_q}{L_d}) (\frac{L_q}{L_d})^2}}{2(1 - \frac{L_q}{L_d})(1 + (\frac{L_q}{L_d})^2) \cos(\gamma)^2 - 2(1 - \frac{L_q}{L_d}) (\frac{L_q}{L_d})^2} )
\end{split}
\end{equation}




Cabe destacar que esta trayectoria solamente se puede ejecutar si se cumple la condición de que $I_{sc} \leq I_{s,max}$.


\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xtick = {-0.6},
        xticklabels={$-\frac{\lambda_m}{L_d}$},  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    
    \draw[black] (0,0) circle [radius=0.8];
    \addplot[red, thick, domain=-0.77:-0.6] {0.5*sqrt(4*(1.111111)^2*(x^2-x*0)+(1.111111)^2*0^2-2.22222222^2*0.6^2)/2.22222222};


    \end{axis}
    \end{tikzpicture}
  \caption{Trayectoria MTPV.}
\end{figure}



\subsubsection{CVL (Límites de Corriente y Voltaje)}

Por último, se presentan los límites eléctricos del motor y del convertidor. El límite de corriente consiste simplemente en saturar la magnitud de la corriente de manera que no sobrepase el valor máximo establecido. La trayectoria sería sencillamente seguir el círculo de corriente anteriormente presentado (CLC), con la siguiente expresión:

\[
I_{s,\text{CLC}} = I_{s,\text{max}} , \forall \gamma \in [0,2\pi]
\]


\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xticklabels=\empty,  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    % Límite de corriente Is_max
    \draw[red, thick] (0,0) circle [radius=0.8];

    \end{axis}
    \end{tikzpicture}
  \caption{Trayectoria CLC.}
\end{figure}


El límite de tensión del motor en realidad se puede entender como la velocidad máxima a la que se puede llegar con una determinada tensión. Por ello, se usa la expresión de las elipses de tensión (VLE):

\begin{equation}
1 \geq \frac{\left(\frac{\lambda_m}{L_d}+I_s \cdot \cos(\gamma)\right)^2}{\left(\frac{\frac{V_{DC}}{\sqrt{3}}}{L_d\cdot\omega_e}\right)^2}+\frac{(I_s \cdot \sin(\gamma))^2}{\left(\frac{\frac{V_{DC}}{\sqrt{3}}}{L_q\cdot\omega_e}\right)^2}
\end{equation}

Igual que para el resto de trayectorias, se debe obtener una expresión de la elipse en función de $I_s$ y $\gamma$. Ya que no es trivial despejar estas variables de la expresión anterior, se manipula usando la ecuación polar de la elipse desplazada del origen:
\begin{equation}
\rho(\theta) = \frac{b^2 x \cos (\theta ) + a^2 y \sin (\theta )\pm a b \sqrt{\left(a^2-x^2\right) \sin ^2(\theta )+\left(b^2-y^2\right) \cos ^2(\theta )+2 x y \sin (\theta ) \cos (\theta )}}{a^2 \sin ^2(\theta )+b^2 \cos ^2(\theta )}
\end{equation}

Dado que estas elipses tan solo están desplazadas en el eje $x$, se pueden eliminar todos los términos referentes al desplazamiento en $y$.
\begin{equation}
\rho(\theta) = \frac{b^2 x \cos (\theta ) \pm a b \sqrt{\left(a^2-x^2\right) \sin ^2(\theta )+\left(b^2\right) \cos ^2(\theta )}}{a^2 \sin ^2(\theta )+b^2 \cos ^2(\theta )}
\end{equation}

Sustituyendo por los términos conocidos y simplificando:

\begin{equation}
	=\frac{\left(\frac{1}{L_q}\right)^2\left(-I_{s c}\right) \cos (\gamma) \pm \frac{1}{L_d \cdot L_q} \sqrt{\left(\left(\frac{V_s}{L_d \cdot \omega_e}\right)^2-\left(-I_{s c}\right)^2\right) \sin ^2(\gamma)+\left(\frac{V_s}{L_q \cdot \omega_e}\right)^2 \cos ^2(\gamma)}}{\left(\frac{1}{L_d}\right)^2 \sin ^2(\gamma)+\left(\frac{1}{L_q}\right)^2 \cos ^2(\gamma)}
\end{equation}


\begin{figure}[H]
  \centering
    \begin{tikzpicture}
    \begin{axis}[
        axis lines=middle,
        width=6cm,
        height=8cm,
        xlabel={$i_d$},
        x label style={at={(axis description cs:0.05,0.6)},anchor=north},
        ylabel={$i_q$},
        %y label style={at={(axis description cs:0.95,0.05}},
        grid=none,
        xmin=-1.2,
        xmax=0.4,
        ymin=-1.2,
        ymax=1.2,
        no markers,
        x axis line style = {stealth-},
        xtick = {-1},
        xticklabels={$-\frac{\lambda_m}{L_d}$},  % Elimina las marcas en el eje x
        yticklabels=\empty,  % Elimina las marcas en el eje y
    ]
    
    
    \draw[black] (0,0) circle [radius=0.8];

    \draw[red, thick] (-1,0) ellipse (0.5 and 0.25);


    \end{axis}
    \end{tikzpicture}
  \caption{Trayectoria VLE.}
\end{figure}



Además, el inversor es capaz de sintetizar un máximo de $V_s = \frac{V_{DC}}{\sqrt{3}}$ utilizando SVPWM, por lo tanto, se debe saturar la consigna de tensión a ese valor. Adicionalmente, por seguridad, se multiplica por un factor de seguridad $K_{FW}$ menor a 1.

\begin{equation}
	V_{s,\text{max}} \leq \frac{V_{DC}}{\sqrt{3}}\cdot K_{FW}
\end{equation}

\subsection{Diseño y simulación del control}

En esta sección, se aborda la implementación del modelo matemático del PMSM en un entorno de simulación. Además, se detallan los pasos cruciales en el diseño del control, destacando la implementación del lazo de control de corriente, el modelo promediado y conmutado del inversor, o la integración de las trayectorias y la estrategia de debilitamiento de campo. Disponer de un modelo de simulación completo permite ganar mucha comprensión sobre el sistema estudiado, pero por el coste computacional suele ser inviable juntar muchos sistemas en una misma simulación.

\subsubsection{EMR (Representación macroscópica energética)}
En primer lugar, se tratará de crear un modelo que permita simular la dinámica electromecánica del PMSM, así como el entorno mecánico en el que se encuentra (vehículo eléctrico) e integrar el control vectorial. Para ello se usará un estándar para modelizar sistemas de potencia, la representación macroscópica energética o EMR por sus siglas en inglés. El concepto se basa en agrupar o dividir las diferentes etapas en las que la potencia se transforma, utilizando el principio de acción-reacción y el principio causal (el efecto causa-efecto causa efecto porque la causa del efecto causa-efecto es a su vez causa y efecto). 

En primer lugar se modeliza la planta eléctrica del PMSM. Se utiliza el modelo con el marco de referencia rotativo $d-q$ por su sencillez. Para ello se implementan las diferentes ecuaciones del motor en bloques separados siguiendo el estándar de la EMR.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{fig/motorEMR1.png}
    \caption{Bloques que representan el PMSM.}
\end{figure}

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.52\linewidth}
        \includegraphics[width=\linewidth]{fig/motorEMR2.png}
        \caption{Circuito eléctrico.}
    \end{subfigure}
    \begin{subfigure}{0.4\linewidth}
        \includegraphics[width=\linewidth]{fig/motorEMR3.png}
        \caption{Conversión electromecánica}
    \end{subfigure}
    \caption{Detalle de los bloques del PMSM}
\end{figure}

También se modela la planta mecánica del motor, así como la transmisión de la potencia mecánica a las ruedas y al vehículo.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\linewidth]{fig/carEMR.png}
    \caption{Planta mecánica.}
\end{figure}

\subsubsection{Lazos de corriente y modelo promediado del inversor}

Como se ha visto hasta ahora, es práctico utilizar la corriente para controlar el motor. Por ello, se implementa un lazo de corriente utilizando controladores PI para el eje $d$ y para el eje $q$ por separado. Como el inversor se utiliza como fuente de tensión, la salida de estos PI es la consigna de tensión. Dado que el motor genera una fuerza contraelectromotriz, se añade como \textit{feed-forward} a los controladores. La salida del controlador no se satura directamente, sino que se implementa una saturación posterior la cual se realimenta al controlador para usar una técnica de \textit{anti-windup}. Las constantes de los controladores se ajustan de la siguiente manera:

% PI de corriente, respuesta de segundo orden
\[
M_p = 15 \%
\]

\[
 t_s = T_s \cdot 20
\]
Donde $M_p$ es el sobre-impulso deseado en la respuesta a una entrada de escalón, $t_s$ es el tiempo de establecimiento deseado, y $T_s$ es la inversa de la frecuencia de control.

\[
\xi = \sqrt{\frac{\log(M_p)^2}{\pi^2 + \log(M_p)^2}}
\]

\[
\omega_n = \frac{3}{\xi \cdot t_s}
\]

\[
Kp_{id} = 2 \cdot \xi \cdot \omega_n \cdot L_d - R_s
\]

\[
Ki_{id} = \omega_n^2 \cdot L_d
\]

\[
Kp_{iq} = 2 \cdot \xi \cdot \omega_n \cdot L_q - R_s
\]

\[
Ki_{iq} = \omega_n^2 \cdot L_q \quad
\]

\begin{figure}[H]
    \begin{subfigure}{0.2\linewidth}
        \centering
        \includegraphics[width=\linewidth]{fig/PIEMR_out.png}
    \end{subfigure}
    \begin{subfigure}{0.75\linewidth}
        \centering
        \includegraphics[width=\linewidth]{fig/PIEMR_in.png}
    \end{subfigure}
    \caption{Bloque de los lazos de corriente.}
\end{figure}

Para las simulaciones se han implementado los siguientes parámetros de motor, ya que aunque a fecha de redacción de este documento no está fabricado, se han estimado de manera que se cumplan los requisitos del motor.


\begin{tabular}{|p{2cm}||p{1cm}|p{1.5cm}|p{7cm}|}
 \hline
 \multicolumn{4}{|c|}{Parámetros del Motor} \\
 \hline
 Parámetro & Valor & Unidades & Descripción \\
 \hline
 pp & 3 & ad & Número de pares de polos \\
 $\lambda_m$ & 52.615 & mWb & Flujo magnético de los imanes permanentes \\
 $L_d$ & 1.887 & mH & Inductancia en el eje d \\
 $L_q$ & 2.831 & mH & Inductancia en el eje q \\
 $R_s$ & 150 & m$\Omega$ & Resistencia de fase del estator \\
 $\omega_{\text{m,max}}$ & 20000 & rpm & Velocidad angular máxima del motor \\
 $T_{\text{em,max}}$ & 26 & N·m & Par máximo del motor \\
 $V_{\text{bat}}$ & 540 & V & Voltaje de la batería DC \\
 $I_{\text{s,max}}$ & 108 & A & Corriente máxima en los ejes d-q \\
 \hline
\end{tabular}



\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\linewidth]{fig/idiq_plot_PI.png}
    \caption{Simulación de los PIs de corriente, con una consigna de $(i_d, i_q) = (-8, 30) A$.}
\end{figure}


Tras obtener las consignas de tensión, se modela el inversor VSI con SVPWM con un modelo promediado, es decir, sin llegar a generar una señal conmutada por PWM. Se usan relaciones básicas para convertir las magnitudes eléctricas del espacio $d-q$ a DC. Además se incorpora la fuente de energía del sistema, la batería, con un simple modelo RC.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.25\linewidth]{fig/VSIEMR_out.png}
    \caption{Bloques que contienen el modelo promediado del VSI con SVPWM.}

\end{figure}

\begin{figure}[H]
    \centering
    \begin{subfigure}{0.45\linewidth}
        \centering
        \includegraphics[width=\linewidth]{fig/VSIEMR_in1.png}
    \end{subfigure}
    \begin{subfigure}{0.45\linewidth}
        \centering
        \includegraphics[width=\linewidth]{fig/VSIEMR_in2.png}
    \end{subfigure}
    \caption{Detalle de los bloques del VSI.}

\end{figure}

\subsubsection{Implementación de las trayectorias de control}

Con lo anteriormente desarrollado solamente se pueden consignar las corrientes $i_d$ e $i_q$ manualmente, pero el objetivo es consignar el par y que el propio control sea capaz de gestionar el debilitamiento de campo. Por ello, se implementan las ecuaciones presentadas en el apartado anterior en bloques de código. 

La estrategia es la siguiente: Se implementan las ecuaciones de las trayectorias cuya salida es una corriente (CLC, CTC, MTPV y VLE) y se selecciona la mínima, o en caso de estar en zona de debilitamiento de campo, la óptima, que no necesariamente es la mínima. En paralelo, se calcula el ángulo que correspondería a la trayectoria del MTPA, y se añade un control integral que aumenta el valor del ángulo controlando la tensión para poder entrar en el resto de trayectorias. Este integrador sería justamente el controlador de debilitamiento de campo y se encarga de que la consigna de ángulo no haga sobrepasar el límite de tensión establecido por el bus DC con un cierto factor de seguridad. Se trabaja con módulos de corriente siempre positivos, y ángulos comprendidos entre $\gamma \in [\frac{\pi}{2}, \pi]$. Para obtener par negativo, simplemente se multiplica el ángulo $\gamma$ por el signo de la consigna de par, atendiendo específicamente al caso de par igual a cero.

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{fig/EMR_FULL.png}
    \caption{Modelo EMR completo.}
    
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\linewidth]{fig/EMR_control.png}
    \caption{Detalle del bloque del lazo de control vectorial.}
    
\end{figure}
\newpage
Para comprobar el funcionamiento y la estabilidad del control, se realiza una simulación en la que la consigna de par está extraída de un perfil de conducción real.

\begin{figure}[!htb]
    \centering
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/Tem_plot.png}
        \caption{Torque electromagnético ($T_{em}$).}
    \end{subfigure}
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/idiq_plot.png}
        \caption{Corrientes ($I_{d} - I_{q}$).}
    \end{subfigure}
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/id-iq_plot.png}
        \caption{Corriente ($I_{d}$) vs Corriente ($I_{q}$).}
    \end{subfigure}
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/wm_Tem_plot.png}
        \caption{Velocidad mecánica ($\omega_{m}$) vs Torque electromagnético ($T_{em}$).}
    \end{subfigure}
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/wm_plot.png}
        \caption{Velocidad mecánica ($\omega_{m}$).}
    \end{subfigure}
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/vdvqPI_plot.png}
        \caption{Voltajes ($V_{d} - V_{q}$).}
    \end{subfigure}
    \caption{Resultados de la simulación.}
    
\end{figure}

Se puede observar que en esta simulación se ha limitado el comportamiento de la frenada regenerativa a la trayectoria del MTPA. Además, se pueden observar ciertos problemas en la implementación del lazo de tensión. Más adelante se realiza una simulación más enfocada en el control que en la aplicación, y en ella se revisan estas situaciones.

\subsubsection{Modelo conmutado}

Dado que el inversor realmente es una fuente conmutada, se debe modelar utilizando una herramienta que lo permita. Utilizando el modelo EMR generado en Simulink se ha implementado la conmutación, pero el tiempo de simulación es demasiado grande como para que sea una herramienta práctica para el desarrollo.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.25\linewidth]{fig/EMR_VSIsw_out.png}
    \caption{Bloques que contienen el modelo conmutado del VSI con SVPWM.}
    
\end{figure}

\begin{figure}[H]
    \centering

    \begin{subfigure}{0.75\linewidth}
        \centering
        \includegraphics[width=\linewidth]{fig/EMR_VSIsw_in1.png}   
    \end{subfigure}
    \begin{subfigure}{0.75\linewidth}
        \centering
        \includegraphics[width=\linewidth]{fig/EMR_VSIsw_in2.png}
    \end{subfigure}
    \caption{Detalle de los bloques del VSI conmutado.}

\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.85\linewidth]{fig/abc_plot.png}
    \caption{Duty cycles y tensiones alternas.}
    
\end{figure}


Por ello se desarrolla un modelo en PLECS que incorpora el lazo de control, el inversor con MOSFETs, la planta mecánica simplificada, y a la cual se le discretiza la adquisición y el control, de manera que es una aproximación muy realista de la posterior implementación en un microcontrolador. Además se incorporan cálculos térmicos de pérdidas y eficiencia.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_overall}
	\caption{Modelo de simulación en PLECS.}
\end{figure}


Se puede observar que la representación de los bloques en este modelo no sigue el EMR, ya que se elige una implementación más práctica y realista. Destaca la implementación de las funciones de control utilizando la librería PERGAMON, desarrollada por el CITCEA-UPC. Esta librería reproduce completamente el código de las funciones matemáticas implementadas en el control, como los PIs, el SVPWM..., en el software PLECS, lo que facilita la correlación de cualquier modelo con la implementación final en un sistema discreto.


A continuación se presentan los diferentes bloques que forman el modelo.
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_plant}
	\caption{Planta electromecánica del conjunto fuente-inversor-motor-carga.}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_mosfets}
	\caption{Detalle del subbloque VSI, donde se realiza la conexión electrotérmica de los módulos de potencia a la fuente DC, al motor y a la \textit{coldplate}.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_MOSFETs-thermal}
	\caption{Tanto los MOSFETs como los diodos integrados están modelados térmicamente de mano del fabricante, lo que facilita mucho la estimación de pérdidas y la simulación térmica.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_acq}
	\caption{Se modelan los tiempos de adquisición del ADC mediante el uso de \textit{zero order holds}. Se implementa la transformada de las corrientes, tanto de $a,b,c$ al espacio $d-q$ como de coordenadas cartesianas a coordenadas polares.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_voltage}
	\caption{Saturación y síntesis de las tensiones $V_d$ y $V_q$ mediante la transformada de Clarke inversa y la modulación SVPWM de la librería PERGAMON. Se modelan también los tiempos muertos de la modulación.}
	\label{fig:plecsvoltage}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_current-loop}
	\caption{Los lazos de corriente están implementados con PIs discretos de la librería PERGAMON y afinados analíticamente con el procedimiento mostrado anteriormente.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{fig/PLECS_currentref}
	\caption{Consigna de corriente con debilitamiento de campo.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_currentref1}
	\caption{Detalle del bloque de cálculo de corriente, donde se implementan las trayectorias de control del PMSM como ecuaciones analíticas resueltas.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{fig/PLECS_tqspeed}
	\caption{Consigna de par y lazo de velocidad como saturación de la consigna de par.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/PLECS_losses}
	\caption{Cálculo de pérdidas, eficiencia y factor de potencia.}
\end{figure}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.4\linewidth]{fig/PLECS_scopes}
	\caption{Visualización y registro de las variables de interés para el análisis y el procesamiento de datos.}
\end{figure}

\begin{figure}[H]
    \centering

    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/PLECS_Tem.png}
        \caption{Torque electromagnético ($T_{em}$) vs Velocidad mecánica ($\omega_{m}$).}
    \end{subfigure}
    %
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/PLECS_idiq.png}
        \caption{Corrientes ($I_{d} - I_{q}$).}
    \end{subfigure}

    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/PLECS_id-iq.png}
        \caption{Corriente ($I_{d}$) vs Corriente ($I_{q}$).}
    \end{subfigure}
    %
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/PLECS_gamma.png}
        \caption{Ángulo de corriente ($\gamma$).}
    \end{subfigure}

    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/PLECS_thermal.png}
        \caption{Temperatura y pérdidas del inversor.}
    \end{subfigure}
    %
    \begin{subfigure}{0.4\textwidth}
        \includegraphics[width=\linewidth]{fig/PLECS_vdvq.png}
        \caption{Voltajes ($V_{d} - V_{q}$).}
    \end{subfigure}

    \caption{Resultados de la simulación.}
\end{figure}



\section{\textit{Hardware}}

\subsection{Requisitos y pre-concepto}

Para definir los requisitos del inversor de tracción, es crucial considerar las restricciones y exigencias del tren de potencia que impone la normativa de la competición, así como los parámetros eléctricos del vehículo en particular en el cual se va a implementar.

\subsubsection{Potencia}
La norma \textit{\textbf{EV2.2.1}} dicta que la potencia en la salida de la batería no debe exceder los 80 kW. Esta restricción es crucial en el diseño del inversor, ya que se prevé que el vehículo sea impulsado por un solo convertidor con esta potencia máxima. Por ende, el inversor debe estar dimensionado para manejar máximos de potencia de hasta 80 kW. Dado que se trata de un inversor doble, la asignación de potencia se divide en 40 kW por motor, aunque se podría necesitar más potencia en uno de los motores durante la aceleración en una curva. Esta decisión se toma pensando en el futuro del equipo, cuando implemente 4 motores, lo que dotaría al vehículo de hasta 160 kW de máximo. Sin embargo, en ese escenario, solo se podrían utilizar 80 kW repartidos entre las 4 ruedas, con un máximo de 40 kW por rueda.

La prueba donde se espera utilizar esta potencia máxima es la \textit{Acceleration}, donde se podría requerir de los 80 kW durante un máximo de 10 segundos, siendo esta una aproximación muy conservadora. Por lo tanto, la potencia máxima queda como:

\(P_{out, max, tot} = 80 \text{kW} (2 \times 40 \text{kW}) \text{(10s máx.)}\)


Por otro lado, el requisito de potencia media es distinto. Sería un error dimensionar la potencia media del inversor como el valor máximo, ya que esto conduciría a un sobredimensionamiento excesivo de la refrigeración, los conductores, los conectores y los dispositivos de potencia. En cambio, se opta por determinar el valor medio de potencia requerido durante la prueba más exigente, la \textit{Endurance}. En esta prueba, el vehículo debe recorrer aproximadamente 22 km, lo que equivale a alrededor de media hora de uso continuo. En la \textit{Endurance}, considerar la frenada regenerativa es esencial, ya que aumenta el valor medio de la potencia total, sumándose a la potencia de tracción. Se ha calculado el valor medio de potencia a partir de una simulación de la \textit{Endurance} que llega a máximos de 80 kW:

\begin{figure}[H]
	\centering
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{fig/powerRMS}
	\end{subfigure}
	\hfill
	\begin{subfigure}[b]{0.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{fig/powerRMS-zoom}
	\end{subfigure}
	\caption{Potencia instantánea que sale de la batería en un evento de \textit{Endurance} (Tiempo completo y detalle de un fragmento).}
\end{figure}

A continuación se muestra el cálculo del valor RMS de la potencia requerida, basado en los datos de potencia:

\begin{verbatim}
	% Calcular el cuadrado de los valores de potencia
	power_squared = power_time.Data.^2;
	
	% Calcular el promedio de los valores cuadrados
	mean_power_squared = mean(power_squared);
	
	% Tomar la raíz cuadrada del promedio de los valores cuadrados para obtener el valor RMS
	power_rms = sqrt(mean_power_squared);
	
	power_rms =
	
	2.3193e+04
\end{verbatim}


Esto demuestra que el valor medio de potencia requerido es considerablemente menor que el pico máximo, en concreto un \(\frac{23.2 \text{kW}}{80 \text{kW}} = 29\%\). Por lo tanto, se dimensiona el inversor considerando una potencia media de 35 kW, es decir, 17.5 kW por motor. Esta cifra proporciona un margen de seguridad de 11.8 kW respecto a la simulación, lo que permite algo de juego en el reparto de potencia entre ambos motores. De esta manera, la potencia constante queda como:

\(P_{out, const, tot} = 35 \text{kW} (2 \times 17.5 \text{kW})\)

Cabe destacar que se está calculando la potencia aparente del convertidor, ya que la potencia activa y la reactiva se reparten en función del factor de potencia, que no es constante y depende de la planta mecánica y la situación del motor. La potencia activa es la que usa el motor para acelerar o frenar, y la reactiva la consume o suministra el DC-link. Otra nota es que la simulación es poco realista puesto que utiliza picos de potencia máxima, cuando en realidad, en la prueba de la \textit{Endurance} se suele limitar el valor de estos picos con tal de extender la autonomía.

Además, existe la norma \textit{\textbf{EV4.1.1} The maximum permitted voltage that may occur between any two electrical connections is 600 VDC and for motor controller/inverters internal low power control signals 630 VDC.}, que impone el límite de 600 V para la tensión de bus máxima. Es de interés que el inversor esté dimensionado a esta tensión de funcionamiento, 600 VDC, para permitir máxima flexibilidad con el diseño de la batería, por ejemplo. Al usar la tensión más alta posible, se obtiene un beneficio en la reducción de la corriente, que implica menos pérdidas en los conductores y permite reducir la sección de cables, pletinas, conectores y otros conductores.

Ya que la estrategia de modulación es SVPWM y la tensión máxima es de 600 V, la tensión alterna fase-neutro de un motor se expresa como:

\(V_{ph-n, pico, 600 VDC} = \frac{V_{DC}}{\sqrt{3}} = \frac{600 \text{V}}{\sqrt{3}} = 346 \text{V}\)

\(V_{ph-n, RMS, 600 VDC} = \frac{V_{ph-n, pico}}{\sqrt{2}} = \frac{346 \text{V}}{\sqrt{2}} = 245 \text{V}\)

Sin embargo, la batería no estará constantemente a 600 VDC, por lo que para poder entregar la potencia de 40 kW pico por inversor en un rango de tensiones adecuado se debería calcular la corriente con una tensión menor. Se escoge 450 VDC como tensión mínima a partir de la cual se puede entregar la potencia máxima de 40 kW por inversor. Entonces, la corriente de fase de un motor queda:

\(V_{ph-n, pico, 450 VDC} = \frac{V_{DC}}{\sqrt{3}} = \frac{450 \text{V}}{\sqrt{3}} = 261 \text{V}\)

\(V_{ph-n, RMS, 450 VDC} = \frac{V_{ph-n, pico}}{\sqrt{2}} = \frac{261 \text{V}}{\sqrt{2}} = 184 \text{V}\)


\(I_{ph, RMS, max} = \frac{P_{out, max}}{3\cdot V_{ph-n, RMS, 450 VDC}} = \frac{40 \text{kW}}{3\cdot184 \text{V}} = 72 \text{A}\)

\(I_{ph, pico, max} = I_{ph, RMS, max}\cdot\sqrt{2} = 72\text{A} \cdot\sqrt{2} = 102 \text{A}\)

De la misma manera que con la potencia, se puede obtener el valor de corriente constante a una tensión menor, ya que el resultado será más restrictivo:

\(I_{ph, RMS, const} = \frac{P_{out, const}}{3\cdot V_{ph-n, RMS, 450 VDC}} = \frac{17.5 \text{kW}}{3\cdot184 \text{V}} = 32 \text{A}\)

\(I_{ph, pico, const} = I_{ph, RMS, const}\cdot\sqrt{2} = 32 \text{A}\cdot\sqrt{2} = 45 \text{A}\)


Iterando el cálculo de potencia, se puede ver que si se dimensiona a estas corrientes, las potencias máxima y constante calculadas a 600 VDC son considerablemente mayores:

\(P_{out, max} = 3\cdot V_{ph-n, RMS, 600 VDC}\cdot I_{ph, RMS, max} = 3\cdot245 \text{V}\cdot 72 \text{A} = 53 \text{kW}\)

\(P_{out, const} = 3\cdot V_{ph-n, RMS, 600 VDC}\cdot I_{ph, RMS, const} = 3\cdot245 \text{V}\cdot 32 \text{A} = 23.5 \text{kW}\)

\(P_{out, max, tot} = 2\cdot P_{out, max} = 2\cdot53 \text{kW} = 106 \text{kW}\)

\(P_{out, const, tot} = 2\cdot P_{out, const} = 2\cdot23.5 \text{kW} = 47 \text{kW}\)

\subsubsection{Normativa}
La normativa de la Formula Student no impone normativas muy restrictivas, ya que la mayoría están enfocadas a la seguridad. Estas son las normas que afectarán al diseño del inversor:

\begin{itemize}

    \item \textit{\textbf{EV2.2.2} Regenerating energy is allowed and unrestricted.} La posibilidad de regenerar energía implica que el inversor debe ser capaz de consignar par en el sentido opuesto a la velocidad de los motores para frenar, lo que tendrá un impacto fundamental en el diseño del control. La topología de VSI es bidireccional en sí misma.
    \item \textit{\textbf{EV2.2.3} Wheels must not be spun in reverse.} Podría impactar la lógica de control del inversor y en la adquisición de los sensores de posición para evitar la marcha atrás. Se pueden implementar algoritmos de dependencia de dirección para que ambos motores traccionen el vehículo en la misma dirección.
    \item \begin{itquote} \textbf{EV3.1.1} TS enclosures, see EV1.1.2, must consist of either
    \begin{itemize}
            \item a grounded solid layer made of at least 0.5 mm thick electrically conductive material, aluminium or better, having a resistance below 300 m$\Omega$, measured with a current of 1 A, to LVS ground and able to continuously carry at least 10\% of the TS accumulator main fuse current rating or 
            \item be fully made out of electrically insulating materials having an isolation resistance of at least 2 M$\Omega$, measured with a voltage of 500 V. The enclosure must be rigid and must prevent possible mechanical penetrations. Protruding electrically conductive parts, such as fasteners or connectors, must follow EV3.1.2
    \end{itemize} The TSAC might use at least 0.9 mm thick steel layer as the grounded layer. \end{itquote} Tendrá efectos en el diseño del empaquetado del convertidor y en la selección de materiales para garantizar la seguridad eléctrica y mecánica del convertidor.

    \item \textit{\textbf{EV3.2.5} All overcurrent protection devices that are part of the TS must not rely on programmable logic. The overcurrent protection function of motor controllers/inverters for the motor outputs may rely on programmable logic.} Los dispositivos de protección contra sobrecorriente en el sistema de tracción para el motor pueden depender de lógica programable, lo que permite utilizar el sensado de corriente para garantizar esta protección.
    \item \textit{\textbf{EV4.1.2} All components in the TS must be rated for the maximum TS voltage. The TS area of a PCB, see EV4.3.6, is considered as one component. Every input connected to the TS must be rated to the maximum TS voltage.} Tendrá efectos en la selección de los componentes del circuito de potencia del inversor.
    \item \textit{\textbf{EV4.1.3}  All components must be rated for the maximum possible temperature that may occur during usage.} Impactará en la selección de componentes que puedan manejar las temperaturas esperadas.
    \item \textit{\textbf{EV4.2.1} TS enclosures, see EV1.1.2, must be labeled with (a) reasonably sized sticker(s) according to “ISO 7010-W012” (triangle with a black lightning bolt on a yellow background). The sticker must also contain the text “High Voltage” if the voltage is more than 60 VDC or 50 VACRMS.} Impacta en los requisitos de señalización y seguridad del empaquetado.
    \item \textit{\textbf{EV4.3.1} The entire TS and LVS must be galvanically isolated, see EV1.2.1 and IN4.1.1.} Afecta el diseño de la separación y el aislamiento entre ambos sistemas.
    \item \textit{\textbf{EV4.3.4} Where both TS and LVS are present within an enclosure, they must be separated by barriers made of moisture-resistant insulating materials or maintain the following spacing through the air, or over a surface:}

	\begin{table}[H]
		\centering
		\caption{Voltage Spacing Requirements}
		\begin{tabular}{|l|l|}
			\hline
			Voltage         & Spacing     \\ \hline
			\(U < 100 \, \text{VDC}\)  & 10 mm       \\ \hline
			\(100 \, \text{VDC} < U < 200 \, \text{VDC}\) & 20 mm       \\ \hline
			\(U > 200 \, \text{VDC}\)  & 30 mm       \\ \hline
		\end{tabular}
	\end{table} Impacta en el diseño del empaquetado del inversor.  Se usarán aislantes como el Nomex en caso de que no se pueda garantizar el espaciado por aire.
    \item \textit{\textbf{EV4.3.6} If TS and LVS are on the same PCB, they must be on separate well-defined areas of the board, meeting the spacing requirements in table 5, each area clearly marked with “TS” or “LV”. The outline of the area required for spacing must  be marked. “Conformal coating” refers to a coating insulator, solder resist is not a coating.}
    
	\begin{table}[H]
		\centering
		\caption{Voltage Spacing Requirements}
		\begin{tabular}{|l|l|l|l|}
			\hline
			Voltage & Over Surface & Through Air (Cut in board) & Conformal Coating \\
			\hline
			0 to 50 & 1.6 mm & 1.6 mm & 1.0 mm \\
			\hline
			50 to 150 & 6.4 mm & 3.2 mm & 2.0 mm \\
			\hline
			150 to 300 & 9.5 mm & 6.4 mm & 3.0 mm \\
			\hline
			300 to 600 & 12.7 mm & 9.5 mm & 4.0 mm \\
			\hline
		\end{tabular}
	\end{table} Tendrá efectos en el diseño de la PCB de potencia.

    \item \textit{\textbf{EV4.5.3} The temperature rating for TS wiring, connections, and insulation must be appropriate for the expected surrounding temperatures but at least 85 ºC.} Influirá en la selección de cables y materiales aislantes.
    \item \textit{\textbf{EV4.5.4} TS components and containers must be protected from moisture in the form of rain or puddles, see IN9.} Impactará en el diseño de la caja.
    \item \textit{\textbf{EV4.5.6} All TS wiring must be completed to professional standards with appropriately sized conductors and terminals and with adequate strain relief and protection from loosening due to vibration etc.} Tendrá efectos en el diseño de las conexiones y terminales.
    \item \textit{\textbf{EV4.5.10} Every TS connector outside of a housing must include a pilot contact/interlock line which is part of the SDC. Housings only used to avoid interlocks are prohibited.} Impactará en el diseño de los conectores y sistemas de interconexión.
    \item \textit{\textbf{EV4.5.11} All TS connections must be designed so that they use intentional current paths through conductors such as copper or aluminium and must not rely on steel bolts to be the primary conductor.} Tendrá efectos en el diseño de las conexiones y la selección de materiales adecuados.
    \item \textit{\textbf{EV4.5.12} All TS connections must not include compressible material such as plastic in the stack-up or as a fastener. FR-4 is allowed.} Impactará en el diseño de las conexiones y la selección de materiales adecuados.
    \item \textit{\textbf{EV4.5.13} TS connectors outside of TS enclosures must be designed in a way, that the TS cannot be activated, see EV4.11, if connected in any way other than the design intent configuration.} Tendrá efectos en el diseño de los conectores y la seguridad.
    \item \textit{\textbf{EV4.5.14} All electrical connections, including bolts, nuts, and other fasteners, in the high current path of the TS must be secured from unintentional loosening. Fasteners must use positive locking mechanisms, see T10.2, that are suitable  for high temperatures, see EV4.5.3.} Impactará en el diseño de los sistemas de fijación y bloqueo, especialmente en las conexiones de potencia.
    \item \begin{itquote} \textbf{EV4.5.16} Soldered connections in the high current path are only allowed if all of the following are true: 
    \begin{itemize}
            \item connections on PCBs
            \item the connected devices are not cells or wires
            \item the devices are additionally mechanically secured against loosening
    \end{itemize} \end{itquote} Tendrá efectos en el diseño de las conexiones y el uso de soldaduras. El uso de sistemas alternativos de conexión en placa como el \textit{press-fit}, facilita el cumplimiento de esta norma.
    \item \textit{\textbf{EV4.9.1} If a discharge circuit is required to meet EV6.1.5, it must be designed to handle the maximum TS voltage permanently. After three subsequent discharges within 15 s in total, the discharge time specified in EV6.1.5 may be exceeded.  Full discharging functionality must be given after a reasonable time with a deactivated discharge circuit.} Se deberá integrar un circuito de descarga en el inversor que cumpla con estos requisitos.
    \item \textit{\textbf{EV4.9.2} The discharge circuit must be wired in a way that it is always active whenever the SDC is open. Furthermore, the discharge circuit must be fail-safe such that it still discharges the intermediate circuit capacitors if the HVD has  been opened or the TS accumulator is disconnected.} Tendrá efectos en la implementación del circuito de descarga.
    \item \begin{itquote} \textbf{EV2.2.1} EV4.10.2 The TSAL itself must have a red light, flashing continuously with a frequency between 2 Hz and 5 Hz and a duty cycle of 50\%, active if and only if the LVS is active and the voltage across any DC-link capacitor exceeds 
    \begin{itemize}
            \item 60 VDC or 50 VACRMS
            \item Half the nominal TS voltage
    \end{itemize} 
    whichever is lower \end{itquote} Se deberá implementar esta detección.
    \item \textit{\textbf{EV4.10.4} The mentioned voltage detection must be performed inside the respective TS enclosure.} Obliga a situar la detección de alta tensión en el propio \textit{DC-link}.

\end{itemize}

Estas restricciones no solo definen los límites de diseño del inversor, sino que también influyen en la selección de componentes y la estrategia de control.

\subsubsection{Resumen de Requisitos de \textit{Hardware}}

Con toda la información que se ha recopilado se pueden listar los requisitos más importantes del convertidor:
\begin{itemize}
	\item \textbf{Topología del convertidor:} VSI doble.
	\item \textbf{Potencia pico:} 80 kW ($2\times40$ kW).
	\item \textbf{Potencia constante:} 35 kW ($2\times17.5$ kW).
	\item \textbf{Tensión DC máxima:} 600 V.
	\item \textbf{Tensión fase-neutro sintetizada máxima:} 245 V,RMS (SVPWM).
	\item \textbf{Corriente de fase máxima:} 80 A,RMS.
	\item \textbf{Aislamiento galvánico entre TS y LVS}.
	\item \textbf{Detección de tensión}.
	\item \textbf{Circuito de descarga integrado}.
	
	
\end{itemize}

\subsubsection{Requisitos Adicionales}
Además de las restricciones normativas, los requisitos del inversor también deben tener en cuenta las demandas específicas del sistema de tracción. Entre estos requisitos se encuentran:

\begin{itemize}
	\item \textbf{Densidad de Potencia:} El inversor debe ser capaz de proporcionar una alta densidad de potencia para facilitar la integración en el vehículo.
	\item \textbf{Eficiencia:} Se busca una eficiencia óptima para maximizar la autonomía del monoplaza y llevar el máximo de energía de la batería a los neumáticos.
	\item \textbf{Fiabilidad:} Dado el entorno de competición, el inversor debe ser altamente confiable y capaz de operar en las condiciones de una competición, como temperaturas ambientales y humedades altas.
	\item \textbf{Flexibilidad:} El diseño del inversor debe ser lo suficientemente flexible para adaptarse a posibles cambios en el sistema de tracción y comunicación con el vehículo.
	\item \textbf{Facilidad de mantenimiento:} Consideraciones para facilitar el mantenimiento y la reparación en caso de fallos durante la competición.
\end{itemize}

\subsubsection{Boceto del empaquetado}

Antes de entrar en el diseño detallado del convertidor, se realizaron algunos bocetos preliminares para visualizar la disposición de los componentes y planificar la distribución espacial. Estos bocetos iniciales sirven como punto de partida para el diseño final del empaquetado del inversor.

\begin{figure}[H]
	\centering
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{fig/boceto1.jpg}
	\end{minipage}\hfill
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{fig/boceto2.jpg}
	\end{minipage}
	\caption{Bocetos preliminares del empaquetado del inversor.}
\end{figure}

En estos dos primeros conceptos se explora el uso de una sola \textit{coldplate} para refrigerar ambos semiconductores. Adicionalmente se propone refrigerar el DC-link, aunque posteriormente se encuentra que no es necesario. Se ha optado por una configuración que separa claramente los módulos de potencia de la placa de control, facilitando así el mantenimiento y la disipación de calor.

\begin{figure}[H]
	\centering
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{fig/boceto3.png}
	\end{minipage}\hfill
	\begin{minipage}{0.45\textwidth}
		\centering
		\includegraphics[width=\textwidth]{fig/boceto4.png}
	\end{minipage}
	\caption{Evolución de los bocetos del empaquetado del inversor.}
\end{figure}

En los bocetos posteriores, se ha refinado la disposición de los componentes para mejorar la accesibilidad y la eficiencia de refrigeración. La disposición de los conectores y la distribución de los conductores también se ha ajustado para optimizar la densidad de potencia y la eficiencia del diseño. Estos cambios reflejan un enfoque hacia un empaquetado más eficiente y funcional del inversor. De todas maneras, todavía presentan muchas complicaciones en el ensamblaje y fabricación de algunos elementos como la \textit{coldplate}.

Estos bocetos iniciales proporcionan una idea visual de cómo se podría organizar el empaquetado del inversor. A medida que avanza el diseño, se realizarán ajustes a la vez que se encuentren limitaciones con los componentes específicos seleccionados y se hagan consideraciones eléctricas y térmicas que en este punto no se han tenido.

\subsection{Topología y concepto}
Con el fin de producir las tensiones trifásicas que calcula el control para los dos motores se implementa un ondulador trifásico fuente de voltaje doble (\textit{dual VSI}). Poniendo el foco en uno solo de los convertidores, existen varias topologías que permiten hacer un ondulador trifásico, pero la más utilizada es el VSI de 2 niveles, formado por tres ramas de medio puente. Otras topologías de más niveles logran sintetizar las tensiones con menos distorsión armónica, pero dado que el motor eléctrico es una carga inductiva, y que el control está basado en consignas de corriente, la distorsión armónica del convertidor tiene un impacto muy poco significativo en el rendimiento global. De esta manera, se justifica la implementación del VSI dual.

\begin{figure}[H]

    \centering
    \begin{circuitikz}
        % Upper MOSFETs
        \draw (0,0) node[nigfete,anchor=D,bodydiode] (M1) {};
        \draw (2,0) node[nigfete,anchor=D,bodydiode] (M2) {};
        \draw (4,0) node[nigfete,anchor=D,bodydiode] (M3) {};

        % Lower MOSFETs
        \draw (0,-2) node[nigfete,anchor=D,bodydiode] (M4) {};
        \draw (2,-2) node[nigfete,anchor=D,bodydiode] (M5) {};
        \draw (4,-2) node[nigfete,anchor=D,bodydiode] (M6) {};

        % Connections
        \draw (M1.S) -- (M4.D);
        \draw (M2.S) -- (M5.D);
        \draw (M3.S) -- (M6.D);
        \draw (M1.D) -- (M2.D) -- (M3.D);
        \draw (M4.S) -- (M5.S) -- (M6.S);

        % Battery
        \draw (M1.D)  |-  ++(-4,0) to[battery, l=$V_{DC}$] ++(0,-3.5)  |-  (M4.S);
        \draw (M1.D)  |-  ++(-1.5,0) to[capacitor] ++(0,-3.5)  |-  (M4.S);

        % Phase cables
        \draw (M3.S)  |-  ++(2,-0.5) node[right, font=\tiny] {C};
        \draw (M2.S)  |-  ++(4,-0.25) node[right, font=\tiny] {B};
        \draw (M1.S)  |-  ++(6,0) node[right, font=\tiny] {A};

    \end{circuitikz}
        \caption{VSI con MOSFETs.}

\end{figure}

Ya que el convertidor implementa código propio, se decide implementar dos VSI en el mismo convertidor, de modo que se opta por unificar algunos elementos de ambos como la refrigeración con el fin de optimizar el peso y el espacio. Esta decisión evita duplicados de medidas, componentes y software, sin embargo, conlleva otros retos, como por ejemplo, que el microcontrolador deberá ser capaz de ejecutar los dos lazos de control al mismo tiempo.

Para adquirir las variables necesarias para el control y la interfaz con el vehículo y sus periféricos, se requieren los submódulos que se presentan en este diagrama de bloques.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\linewidth]{fig/Inverter_HW}
	\caption{Diagrama de bloques del sistema completo.}
\end{figure}

El convertidor se divide en 3 PCBs, \textit{Inverter Power}, que se instala por duplicado (una por motor), e \textit{Inverter Control}. Como su nombre indica, \textit{Inverter Power} alojará todos los componentes de potencia, incluyendo los \textit{gate drivers}, los sensores de corriente, los semiconductores, los DC-links y los conectores de potencia. Además, en esta placa se puede encontrar el sensado de la tensión de los buses, los circuitos de descarga, y la detección de alta tensión para la \textit{TSAL}. El sensado de tensión sería el único subcircuito repetido, pero esto solamente aporta redundancia y tolerancia al fallo.

Por su parte, \textit{Inverter Control} contiene el microcontrolador de la familia STM32F7 para consignar la conmutación a los \textit{gate drivers}, así como para realizar las lecturas de corriente, tensión y temperatura, las interfaces con los sensores de posición de los motores o los protocolos comunicación CAN y USB.

El montaje de estas placas se realiza de forma compacta y eficiente, de manera que cabe una \textit{coldplate} entre medias de las dos de potencia para refrigerar los semiconductores de ambos inversores. Se encajan de manera que la placa de control se puede conectar a las placas de potencia mediante conectores placa a placa. Las conexiones de potencia facilitan la integración con el cableado del monoplaza debido a su posicionamiento.


\subsection{Semiconductores}

\subsubsection{Tecnología de Semiconductores}

La decisión de emplear MOSFETs de carburo de silicio (SiC) como interruptores se fundamenta en consideraciones específicas de la aplicación y en los requisitos de la competición. En un entorno donde la reducción de peso y volumen es crucial, el SiC emerge como una opción destacada frente a alternativas como el IGBT de silicio, el FET de GaN o el MOSFET de silicio. Aunque que el precio no es una restricción principal en este contexto, el atractivo del proyecto ha logrado captar la atención de empresas que han proporcionado muestras de semiconductores para el desarrollo del convertidor.

Las ventajas inherentes del SiC, como su rendimiento superior o su resistencia a temperaturas más altas, permiten un diseño más compacto y robusto del inversor de tracción. Estas características son esenciales para cumplir con los requisitos de un monoplaza de competición, donde lograr altas densidades de potencia es muy beneficioso para la integración del resto de componentes del vehículo y aligeramiento del mismo.

\subsubsection{Módulos de Potencia}

En el diseño del inversor de tracción, se optó por módulos \textit{half-bridge} debido a su idoneidad para el rango de potencias y tensiones del convertidor. Dos modelos de semiconductores se consideraron para su integración: el DFS05HF12EYR1 de Leapers Semiconductor y el CAB016M12FM3 de Wolfspeed.

Ambos modelos cumplen estrictamente con los requisitos de la aplicación, con un voltaje de ruptura (\(V_{DS,breakdown}\)) de 1200V y una corriente máxima (\(I_{DS,max}\)) que excede los 80 ARMS. La elección de dos modelos distintos se basa en la intención de realizar pruebas comparativas para verificar las diferencias entre ambos.

El DFS05HF12EYR1 ofrece especificaciones muy buenas en su datasheet, aunque Leapers Semiconductors no lleva muchos años en la industria y no han logrado crear la confianza que otras empresas han conseguido con su experiencia. Por otro lado, el CAB016M12FM3, de la reconocida marca Wolfspeed (antiguamente CREE), aporta la confiabilidad asociada a una empresa con amplia experiencia en el campo.

Según sus respectivos datasheets, ambos modelos permiten alcanzar sin mucho esfuerzo una frecuencia de conmutación de 50 kHz, lo que contribuye significativamente a la reducción del tamaño del bus de continua y optimiza el empaquetado del inversor. La placa de potencia se diseñará para permitir la prueba de ambos modelos, ya que comparten \textit{footprint}, facilitando la adaptabilidad y la evaluación comparativa.

A continuación se muestra una tabla comparativa con los detalles de cada semiconductor:
\begin{table}[H]
	\centering
	\begin{tabular}{|l|l|l|}
		\hline
		\textbf{Parámetro} & \textbf{DFS05HF12EYR1} & \textbf{CAB016M12FM3} \\ \hline
		\(V_{DS,\text{breakdown}}\) [V] & 1200 & 1200 \\ \hline
		\(R_{on}\) [\(m \Omega\)] & 5.5 - 13 & 16.0 - 28.8 \\ \hline
		\(V_{f,D}\) [V] & 3.3 - 4 & 4.9 - 5.5 \\ \hline
		\(T_{rr}\) [ns] & 41.5 - 45 & 20.0 \\ \hline
		\(Q_{rr}\) [\(\mu C\)] & 2.19 - 3.94 & 1.30 \\ \hline
		\(R_{th,jc}\) [K/W] & 0.12 - 0.15 & 0.543 \\ \hline
		\(Q_{G}\) [\(nC\)] & 520 & 236 \\ \hline
		\(C_{in}\) [nF] & 14.5 & 6.6 \\ \hline
		\(R_{G,\text{int}}\) [\(\Omega\)] & 1.9 & 2.4 \\ \hline
		\(V_{GS,\text{th}}\) [V] & 2.8 - 4.8 & 1.8 - 3.6 \\ \hline
		\(I_{DS,\text{max}}\) [A] & 150 & 89 \\ \hline
		& \includegraphics[width=0.2\textwidth]{fig/DFS05.png} & \includegraphics[width=0.2\textwidth]{fig/CAB016.png} \\
		\hline
	\end{tabular}
	\caption{Comparación de parámetros entre DFS05HF12EYR1 y CAB016M12FM3.}
\end{table}

\subsubsection{Análisis de Pérdidas}

Los dispositivos semiconductores experimentan pérdidas de energía que influyen significativamente en su eficiencia y desempeño, y se transforman en calor, limitando así la potencia de salida. Estas pérdidas pueden clasificarse en dos categorías fundamentales: las pérdidas de conducción y las pérdidas de conmutación. Las \textbf{pérdidas de conducción} surgen cuando el dispositivo se encuentra en estado activo, conduciendo corriente a través de él. Esto genera una caída de voltaje y una disipación de potencia asociada a la resistencia interna del dispositivo. Por otro lado, las \textbf{pérdidas de conmutación} se manifiestan durante los ciclos de activación y desactivación del dispositivo, cuando la energía almacenada en la capacitancia del mismo se disipa durante la transición entre los estados de conducción y corte.

En el análisis de la eficiencia de los semiconductores, es imperativo considerar las pérdidas totales, las cuales se definen como la suma de las pérdidas de conducción y las de conmutación:

\[ P_{\text{tot}} = P_{\text{cond}} + P_{\text{conm}} \]

A continuación, se examinarán detalladamente las pérdidas de conducción, seguidas por un análisis exhaustivo de las pérdidas de conmutación en los módulos seleccionados.


\textbf{Pérdidas de conducción}

Las pérdidas de conducción tienen su origen en la resistencia entre drenador y fuente cuando el MOSFET está en estado de conducción, o en la caída de tensión del diodo cuando es el diodo quien está conduciendo. Según la ley de Ohm y la definición de potencia:

\[
P_{\text{cond,MOSFET}}= I_{DS}^2\cdot R_{DS, on}
\]

\[
P_{\text{cond},D} = I_{SD}\cdot V_f
\]

Sin embargo, estas expresiones se corresponden con las pérdidas instantáneas y no son útiles a la hora de dimensionar el convertidor. Para ello son necesarias las pérdidas promediadas, pero tienen una expresión analítica muy compleja, ya que dependen de la estrategia de modulación, el índice de modulación instantáneo, el factor de potencia instantáneo, etc. Para el inversor se utiliza SVPWM, pero el cálculo de pérdidas tiene demasiados parámetros instantáneos. Muchas referencias asemejan las pérdidas en SVPWM a las de una modulación PWM sinusoidal (SPWM), con lo que las pérdidas se simplifican y no dependen del desfase entre tensión y corriente $\phi$:

\[
P_{\text{cond,MOSFET}} \approx I_{\text{RMS}} V_{Q0} \left(\frac{1}{\pi\sqrt{2}} + \frac{m PF}{2\sqrt{8}}\right) + I_{\text{RMS}}^2 R_Q \left(\frac{1}{4} + \frac{2m}{3\pi PF}\right)
\]

\[
P_{\text{cond},D} \approx I_{\text{RMS}} V_{D0} \left(\frac{1}{\pi\sqrt{2}} - \frac{m PF}{2\sqrt{8}}\right) + I_{\text{RMS}}^2 R_D \left(\frac{1}{4} - \frac{2m}{3\pi PF}\right)
\]

Como se puede apreciar, aunque son más compactas que otras en la bibliografía, estas expresiones son difíciles de abordar, puesto que casi todos los parámetros son instantáneos. Por ello, se ha usado PLECS para estimar las pérdidas de conducción debido a que facilita la simulación detallada de los semiconductores y permite obtener las pérdidas de forma diseccionada por cada dispositivo y tipo de pérdida. PLECS utiliza modelos detallados de los dispositivos, considerando sus características de conmutación y conducción reales.

Con los parámetros de estos modelos, PLECS calcula las pérdidas de conmutación y conducción de manera precisa. Sin embargo, como no tiene en cuenta el circuito completo de los \textit{gate drivers}, no se pueden tomar directamente las pérdidas de conmutación. Se usa un modelo de MOSFET y diodo de Wolfspeed proporcionado directamente por el fabricante. Este modelo cuenta con una parametrización de las pérdidas y los efectos térmicos mucho más detallada que la que se puede obtener a partir de la hoja de datos. El fabricante utiliza tablas de búsqueda en función de la tensión, corriente y temperatura, e incorpora una relación matemática con las resistencias de puerta. Lamentablemente, Leapers no ofrece esta parametrización con sus semiconductores, por lo que el análisis en PLECS se realiza únicamente con el modelo de Wolfspeed, siendo este el más restrictivo en cuanto a las pérdidas de conducción.

Para sacarle el máximo partido, se ha obtenido un perfil de pérdidas a máxima potencia para el inversor en diferentes zonas de control del PMSM, que se puede observar a continuación.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\linewidth]{fig/PLECS-invLosses}
	\caption{Descomposición de las pérdidas de los semiconductores de una simulación en PLECS.}
	\label{losses-sim}
\end{figure}

Se puede ver como las pérdidas de conducción son más significativas que las de conmutación, y varían significativamente. Las zonas de par constante (de 1,05 s a 1,4 s por ejemplo), muestran unas pérdidas casi constantes con la corriente, pero crecen debido a la temperatura. Se anota para una comparación posterior que las pérdidas de conmutación de los MOSFETs están entre 150 y 200 W. Al entrar en la zona de límite de tensión (de 1,4 s a 1,45 s), se observa un pico que se corresponde con la zona de potencia constante, que en esta simulación es la potencia máxima. Para obtener un valor constante de pérdidas con el que diseñar la refrigeración, se parte de este valor de pico (450 W aproximadamente) y se trata de la misma manera que la relación de potencia media respecto a la potencia pico calculada en la sección de requisitos.

\[
\frac{P_{RMS}}{P_{pico}} = \frac{35 kW}{80 kW} = 0.4375 \approx 0.5
\]

Con este razonamiento, se da un valor de pérdidas de conducción promedio del inversor de $450 \text{W} \cdot 0.5 = 225$ W. Como hay dos inversores anclados a la misma \textit{coldplate}, las pérdidas de conducción que debe disipar es de $225 \text{W} \cdot 2 = 450$ W. Es importante recordar que estas pérdidas son para el semiconductor de Wolfspeed. Dado que las pérdidas de conducción son proporcionales a $R_{DS, on}$, se pueden aproximar las pérdidas de conducción del semiconductor de Leapers de la siguiente manera:
\[
P_{\text{cond,Wolfspeed}} = 450 \text{W}
\]

\[
P_{\text{cond,Leapers}} \approx P_{\text{cond,Wolfspeed}} \cdot \frac{R_{DS, on, Leapers}}{R_{DS, on, Wolfspeed}} = 450 \text{W} \cdot \frac{5.5 \text{m}\Omega}{16 \text{m}\Omega} \approx 155 \text{W}
\]


\textbf{Pérdidas de conmutación}

El cálculo de las pérdidas de conmutación es más fácil de determinar de forma analítica, aunque depende del circuito de \textit{gate driver} y de sus parásitos. Si no se tienen en cuenta estos dos factores, se pueden calcular utilizando los valores de \(E_{on}\) y \(E_{off}\), que representan la energía necesaria para encender o apagar el dispositivo respectivamente. Cuando las hojas de datos de los semiconductores proporcionan los valores \(E_{on}\) y \(E_{off}\), las pérdidas de conmutación pueden calcularse de forma directa. Estas pérdidas están influenciadas por la tensión de conmutación, la corriente de conmutación, la temperatura de la unión y la resistencia de puerta. La fórmula comúnmente utilizada para calcular las pérdidas es:

\[
E_{conm}(t) = (E_{on} + E_{off}) \left( \frac{I_{Q,env}(t)}{I_{test}} \right)^{K_i} \left( \frac{V_{DC}}{V_{test}} \right)^{K_v}
\]

Donde \(I_{Q,env}(t)\) es la corriente de conmutación en cada instante de tiempo, \(I_{test}\) y \(V_{test}\) son los valores de prueba, y \(K_i\) y \(K_v\) son coeficientes de ajuste que normalmente son igual a 1. Esta fórmula permite calcular la potencia media de las pérdidas de conmutación.

Si la corriente es continua, la fórmula simplificada es:

\[
P_{conm} \approx (E_{on} + E_{off}) f_{conm} \frac{I_{out}}{I_{test}} \frac{V_{DC}}{V_{test}}
\]

Y si la corriente es una sinusoide semi-rectificada con un valor de pico de \(\sqrt{2} I_{rms}\) (como en el caso del SVPWM), la fórmula es:

\[
P_{conm} \approx (E_{on} + E_{off}) f_{conm} \frac{\sqrt{2} I_{rms}}{\pi I_{test}} \frac{V_{DC}}{V_{test}}
\]

Sustituyendo por los valores del convertidor en diseño:

\begin{itemize}
	\item Generales: \(f_{\text{conm}} = 50 \, \text{kHz}\), \(I_{\text{rms}} = 80 \, \text{A}\), \(V_{DC} = 600 \, \text{V}\)
	\item Leapers: \(E_{\text{on}} = 3.54 \, \text{mJ}\), \(E_{\text{off}} = 1.59 \, \text{mJ}\), \(V_{\text{test}} = 600 \, \text{V}\), \(I_{\text{test}} = 150 \, \text{A}\)
	\item Wolfspeed: \(E_{\text{on}} = 1.13 \, \text{mJ}\), \(E_{\text{off}} = 0.54 \, \text{mJ}\), \(V_{\text{test}} = 600 \, \text{V}\), \(I_{\text{test}} = 80 \, \text{A}\)
\end{itemize}

Para los dispositivos Leapers, sustituyendo en la fórmula:

\[
P_{\text{conm}} \approx (3.54 \text{mJ} + 1.59 \text{mJ}) \times 50 \text{kHz} \times \frac{80 \text{A}}{150 \text{A}} \times \frac{600 \text{V}}{600 \text{V}}
\]

\[
P_{\text{conm, Leapers}} \approx 61.58 \text{W}
\]

Para los dispositivos Wolfspeed:

\[
P_{\text{conm}} \approx (1.13 \text{mJ} + 0.54 \text{mJ}) \times 50 \text{kHz} \times \frac{80  \text{A}}{80 \text{A}} \times \frac{600 \text{V}}{600 \text{V}}
\]

\[
P_{\text{conm, Wolfspeed}} \approx 37.59 \text{W}
\]

Dado que estas pérdidas son para un solo MOSFET, se deben multiplicar por 12 para obtener las pérdidas de conmutación totales, dado que hay 6 dispositivos de potencia en la topología VSI y hay dos VSIs en el convertidor.

\[
P_{\text{conm, Leapers, tot}} = 12\cdot P_{\text{conm, Leapers}} \approx 739 \text{W}
\]

\[
P_{\text{conm, Wolfspeed, tot}} = 12\cdot P_{\text{conm, Wolfspeed}} \approx 451 \text{W}
\]

Con tal de verificar estas pérdidas, se puede revisar la simulación realizada anteriormente, mostrada en la figura \ref{losses-sim}. En ella, se pueden apreciar unos 150 W de pérdidas de conducción para el semiconductor de Wolfspeed, lo cual se alinea con el cálculo analítico realizado, siendo este último un tanto más conservador (hay que tener en cuenta que la simulación usa solamente un VSI). Dado que no se han tenido en cuenta los efectos de $R_{G, on}$, $R_{G, off}$ ni ningún tipo de caracterización del \textit{gate driver}, se debe saber que el valor real puede ser más alto o más bajo, y dependiente de muchos factores que harían complejo su análisis.


\textbf{Resumen de pérdidas}

El siguiente gráfico presenta una comparación detallada de las pérdidas de conducción y conmutación para los semiconductores de Leapers y Wolfspeed.

\begin{figure}[H]
	\centering
	\begin{tikzpicture}
		\begin{axis}[
			ybar stacked,
			width=0.65\textwidth,
			yticklabel style={/pgf/number format/.cd,fixed,fixed zerofill,precision=0,/tikz/.cd},
			ylabel={Pérdidas (W)},
			symbolic x coords={Leapers, Wolfspeed},
			xtick=data,
			bar width=8pt, % Ancho de las barras
			enlarge x limits=0.25, % Espacio adicional a ambos lados de las barras
			nodes near coords,
			nodes near coords align={vertical},
			every node near coord/.append style={font=\scriptsize, xshift=-15pt, yshift=0pt},
			legend style={
				at={(0.5, 0.9)},
				anchor=north,
			},
			]
			\addplot coordinates {(Leapers, 155) (Wolfspeed, 450)};
			\addplot coordinates {(Leapers, 739) (Wolfspeed, 451)};
			\legend{Conducción, Conmutación}
		\end{axis}
	\end{tikzpicture}
	\caption{Comparación de pérdidas de conducción y conmutación}
	\label{fig:loss_comparison}
\end{figure}

Se observa que en el caso de Leapers, las pérdidas de conducción exhiben una significativa disminución en comparación con las de Wolfspeed, mientras que las pérdidas de conmutación muestran un incremento dramático para Leapers en relación con Wolfspeed. Este fenómeno sugiere que, en líneas generales, los dispositivos desarrollados por Leapers podrían ofrecer un camino de corriente más favorable en el semiconductor, y los dispositivos de Wolfspeed son capaces de conmutar más rápido debido a que su carga $Q_G$ es mucho menor, reduciendo así $E_{on}$ y $E_{off}$.

La suma total de las pérdidas de ambos inversores, independientemente del semiconductor, se sitúa entorno a los 900 W, valor con el cual se puede diseñar el sistema de refrigeración.

\subsection{Sistema de Refrigeración}

A continuación se presenta una comparación entre las opciones comunes para refrigerar el inversor:

\begin{table}[H]
	\centering
	\begin{tabular}{|p{2.5cm}|p{5cm}|p{5cm}|}
		\hline
		\textbf{Opción de Refrigeración} & \textbf{Ventajas} & \textbf{Desventajas} \\ \hline
		Convección Natural & Económica, Sin partes móviles & Limitada disipación de calor, Depende del ambiente \\ \hline
		Disipador de Calor & Económico, Fácil de instalar, No requiere energía adicional & Limitado en aplicaciones de alta potencia, Depende del ambiente \\ \hline
		Ventilador & Buena disipación de calor, Control de temperatura & Limitado en aplicaciones de alta potencia, Ruido \\ \hline
		\textit{Coldplate} de Agua & Excelente capacidad de disipación, Buen control de temperatura & Coste, Mantenimiento, Posible riesgo de fugas, Instalación complicada \\ \hline
		\textit{Coldplate} de Aceite & Buena capacidad de disipación, No corrosivo, Alto rango de temperaturas &  Coste, Mantenimiento, Posible riesgo de fugas, Instalación complicada \\ \hline
	\end{tabular}
	\caption{Comparación de Opciones de Refrigeración}
\end{table}



Para el sistema de refrigeración de los semiconductores se ha optado por un sistema de refrigeración líquida consistente en una \textit{coldplate}, una bomba y un radiador. Esta elección se basa en varios factores clave que se detallan a continuación:

\begin{itemize}
	\item \textbf{Mantenimiento de Temperatura:} A diferencia de una refrigeración por aire, una \textit{coldplate} permite mantener una interfaz de temperatura fija para los semiconductores. Esto es crucial para garantizar un funcionamiento estable y confiable de los componentes, especialmente en aplicaciones de alta potencia como la que se está diseñando.
	
	\item \textbf{Experiencia Previa:} El equipo tiene experiencia previa en sistemas de refrigeración líquida, lo que facilita la implementación y mantenimiento de este tipo de sistemas.
	
	\item \textbf{Eficiencia Compacta:} La refrigeración líquida, especialmente con agua, permite un diseño más compacto en comparación con otras opciones. Un disipador haría mucho más voluminoso el convertidor, mientras que la refrigeración líquida permite una distribución más libre de los componentes por el monoplaza. Por ejemplo, se puede situar el radiador en una zona donde tenga mucho contacto con el aire exterior, y conectarlo mediante mangueras a la bomba y a la \textit{coldplate}.
	
	
\end{itemize}

Aunque el carburo de silicio tiene una temperatura máxima de la unión (\(T_{j(max)}\)) notablemente alta, se ha establecido un objetivo de mantener el delta de temperatura (\(\Delta T\)) por debajo de 30 ºC, manteniendo la interfaz térmica del semiconductor a 80ºC como máximo. Este enfoque busca garantizar una operación óptima y una vida útil prolongada de los semiconductores, además de mitigar los posibles efectos negativos derivados del calor.

Se ha elegido agua como el fluido de refrigeración por varias razones:

\begin{itemize}
	\item \textbf{Norma T7.2.2:} Según la norma T7.2.2, los sistemas de refrigeración solo pueden utilizar agua, aire u aceite como refrigerante. Con lo cual, no es posible utilizar líquidos refrigerantes específicos.
	
	\item \textbf{Propiedades Térmicas:} El agua tiene una alta capacidad calorífica y conductividad térmica, lo que la hace eficaz para disipar el calor generado por los semiconductores. El aceite tiene peor conductividad térmica, y su amplio rango de temperaturas no es útil para la aplicación.
	
	\item \textbf{Seguridad:} El agua es un fluido seguro y no inflamable, lo que reduce los riesgos de seguridad en caso de fugas o accidentes. Además, es un fluido fácilmente disponible y de bajo costo en comparación con otros refrigerantes. Si se usa agua destilada, el riesgo de corrosión es más bajo, y los sistemas electrónicos no serán tan susceptibles a posibles fugas.
	
\end{itemize}


\subsection{Gate drivers}

Los gate drivers son componentes críticos en un convertidor de potencia, puesto que son los encargados de conectar las señales débiles de un microcontrolador con los semiconductores. Además, suelen llevar funcionalidades adicionales como la detección de cortocircuitos en el semiconductor, la lectura de señales analógicas de forma aislada, o mecanismos de protección avanzados.

\subsubsection{Funcionamiento Genérico}

Los \textit{gate drivers} desempeñan un papel esencial en la conmutación eficiente de los MOSFETs, proporcionando los niveles de tensión y corriente adecuados para activar y desactivar rápidamente los transistores. 

\subsubsection{Criterios de Selección}

Al seleccionar un \textit{gate driver}, varios factores deben tenerse en cuenta para garantizar un rendimiento óptimo del sistema:

\begin{itemize}
	\item Topología: A pesar de que hay soluciones que incluyen 6 \textit{drivers} en un solo encapsulado, las más comunes son los circuitos integrados diseñados para controlar un solo dispositivo o dos en configuración de medio puente. Sin embargo, encontrar esta última opción para el rango de tensiones de 600 V con características óptimas es difícil. Por lo tanto, la topología más adecuada suele ser la de un solo \textit{driver} por encapsulado.
	\item Tensión de aislamiento: Dado que las señales de puerta vienen del sistema de baja tensión, deben aislarse antes de llegar al \textit{gate}, con lo que será necesario buscar un componente aislado a una tensión adecuada de al menos tres veces superior a la tensión máxima del inversor, 600 V. 
	\item Corriente de salida: Es crucial elegir un \textit{gate driver} que pueda suministrar la corriente necesaria para cargar y descargar rápidamente las capacidades de compuerta de los MOSFETs. La corriente necesaria depende de la resistencia de puerta, pero se puede determinar una primera cota de $\frac{V_{GS,typ}}{R_{G,int}} = \frac{20 \text{V}}{2.4 \Omega} = 8.3 \text{A}$
	\item Protecciones integradas: Funciones como la lectura de señales analógicas, la posibilidad de paralelizar salidas o la inclusión de protecciones son muy beneficiosas para la integración del convertidor.
\end{itemize}

\subsubsection{Comparativa de Alternativas}

A continuación se presenta una comparativa entre varios modelos de \textit{gate drivers}, considerando sus características principales:

\begin{table}[H]
	\centering
	\begin{tabular}{|l|p{3.5cm}|p{3.5cm}|p{3.5cm}|}
		\hline
		\textbf{Características} & \textbf{ADUM4146} & \textbf{UCC21710} & \textbf{GD3160} \\
		\hline
		Voltaje de Operación & -15 V hasta 30 V & –17.5 V hasta 36 V & -12 V hasta 25V \\
		\hline
		Corriente de Salida & 4.61 A (cortocircuito fuente) & 10 A & 15 A \\
		\hline
		Protecciones & Desaturación, UVLO & Sobrecorriente, Desaturación, \textit{Miller Clamp} & Desaturación, Sobrecorriente, Apagado suave \\
		\hline
		Tiempo de Retardo & 75 ns & 90 ns & - \\
		\hline
		Aislamiento & 5 kV & 5.7 kV & 8 kV \\
		\hline
		Extras & - & Sensor analógico aislado & Sensor analógico aislado \\
		\hline
		CMTI & 100 V/ns & 150 V/ns & 100 V/ns \\
		\hline
	\end{tabular}
	\caption{Comparación de \textit{gate drivers}}
\end{table}

Considerando los criterios de selección, se observa que el UCC21710 se presenta como una opción intermedia adecuada. En primer lugar, la corriente de salida que ofrece es de hasta 10 A, lo que lo hace adecuado para cargar y descargar rápidamente las capacidades de compuerta de los MOSFETs, cumpliendo así con uno de los requisitos fundamentales. Además, integra protecciones contra sobrecorriente y desaturación, así como la funcionalidad de \textit{Miller Clamp}. Además, la inclusión de un sensor analógico aislado proporciona la capacidad de monitorear la temperatura de los semiconductores con sus sensores integrados sin ningún componente adicional.

Aunque las protecciones de sobrecorriente y desaturación son elementos fundamentales para garantizar la seguridad y el correcto funcionamiento de un inversor, en este caso se ha optado por no implementarlas debido a las complicaciones que pueden surgir en el diseño del \textit{layout}. Estas protecciones requieren la inclusión de componentes adicionales con \textit{footprints} grandes y un enrutamiento más complejo de las señales, lo cual puede resultar en problemas de interferencia y aumento de la complejidad del circuito.

Es importante destacar que este inversor se encuentra en una fase inicial de prototipado y desarrollo, donde se prioriza la funcionalidad básica y la viabilidad del diseño. En futuras revisiones y etapas de desarrollo, se considerará la inclusión de estas protecciones, ya que son cruciales para proteger tanto el inversor como los dispositivos conectados. La decisión actual de omitir estas protecciones se basa en la necesidad de simplificar el diseño y garantizar una implementación más eficiente y manejable en esta fase del proyecto.

\subsubsection{Cálculos del Gate Driver Seleccionado}


\begin{itemize}
	
	\item \textbf{Tensión \textit{gate-source}}: Uno de los valores más importantes a determinar es el nivel de tensión de puerta para encender y apagar el MOSFET. En una aplicación \textit{hard-switched} como la del convertidor en diseño, es beneficioso usar una tensión de encendido tan alta como sea posible.
	
	Dada la naturaleza rápida del carburo de silicio, se prevé una dV/dt considerable, la cual puede causar varios problemas. Uno de ellos sería la activación accidental de un MOSFET, la cual causaría la condición de \textit{shoot-through}. Una estrategia para mitigar parcialmente este problema es el uso de un \textit{gate driver} con \textit{Miller Clamp}. Además, se suele apagar el dispositivo utilizando una tensión negativa, que amortigua posibles interferencias en la puerta del dispositivo afectado. El valor de tensión negativo al cual se encuentre la puerta aumenta la tensión que debe inducirse en ese nodo para llegar a la tensión umbral $V_{G,treshold}$ del MOSFET. Dado que el valor óptimo no es trivial, conviene implementar alguna manera de modificarlo, por ejemplo, mediante el uso de un regulador lineal.
	
	Los dispositivos seleccionados tienen un rango de tensiones $V_{GS}$ un tanto distintos, siendo el de Leapers de +21 V a -2 V, y el de Wolfspeed de +15 V a -4 V.
	
	\item \textbf{Potencia de alimentación del \textit{gate driver}:} Se estima en función de la frecuencia de conmutación y la carga de la compuerta de los MOSFETs, además de la tensión $V_{GS}$.
	
	\[
	I_{supply, min} = f_{conm}\cdot Q_G = 50 \text{kHz} \cdot 520 \text{nC} = 26 \text{mA}
	\]
	\[
	P_{supply, min} = \Delta V_{GS}\cdot I_{supply, min} = 20 \text{V} \cdot26 \text{mA} = 0.52 \text{W}
	\]
	
	Con esta estimación de potencia mínima requerida, es esencial seleccionar una fuente adecuada para los \textit{gate drivers}. En este contexto, se considera la serie MGJ2 de Murata, que ofrece características como:
	\begin{itemize}
		\item Tensión de entrada de 5 V, 12 V, 15 V o 24 V, lo que permite adaptarse a diferentes fuentes de alimentación disponibles. En esta aplicación, la entrada de 5 V simplifica mucho la arquitectura de \textit{hardware}.
		\item Rango de tensiones de salida como +15V/-3V, +15V/-5V, +15V/-8.7V, +15V/-15V, +17V/-9V, +18V/-2.5V, +18V/-5V, +20V/-3.5V y +20V/-5V, que permite intercambiar fuentes para probar distintos niveles de tensión.
		\item Aislamiento reforzado hasta 5.2 kVDC, garantizando la seguridad y el cumplimiento de la normativa.
		\item Caracterización de CMTI mayor a 200 V/ns, lo que garantiza una respuesta rápida y efectiva ante transitorios de alta velocidad.
	\end{itemize}
	
	\item \textbf{Valores de Resistencias de Puerta (\(R_{G_{ON/OFF}}\)):} Reducir el valor de las resistencias de puerta conlleva la disminución de las pérdidas de conmutación, ya que los MOSFETs cambiarán más rápido y, por lo tanto, pasarán menos tiempo en la etapa de conmutación. Esta rapidez en el cambio implica un mayor dV/dt, lo que puede ser responsable del aumento de la interferencia electromagnética (EMI). El valor de estas resistencias se estimará mejor con pruebas empíricas, pero se puede partir de un valor de referencia de la hoja de datos, que en este caso es de 3.3 $\Omega$.
	
\end{itemize}


\subsection{Bus de condensadores}

Justificacion de su existencia

cálculo de Irms y Vrip

Selección

\subsection{Conductores}

Pletinas

Cables

Conectores

Análisis de parasitos (Lcable), etc.

\subsection{Sensor de posición}

\subsection{PCB de potencia}

explicacion del concepto y de la(s) PCB

justificacion de conectores / interfaces

justificacion numero de capas, etc.

\subsection{PCB de control}

explicacion del concepto y de la(s) PCB

justificacion de conectores / interfaces

justificacion numero de capas, etc.


\section{\textit{Software}}

\subsection{Concepto}

Diagrama de bloques de software, justificado (ojo, detallar el dual)

Abstraccion ECU, estandarizacion, RTOS

Shield con seleccion de microcontrolador


\subsection{Retos}

velocidad MCU

sincronizacion de ambos inversores

mensajes con el coche

\subsection{Tareas}

Init

ADCs

Comunicaciones

PWMs

Flash o EEPROM

Seguridad

\subsection{Interfaz de usuario}

justificar ausencia de UI integrada

Interfaz de HW 

PlotJuggler

Debugger

Actualizacion de parametros por CAN

\section{Validación}
xd

